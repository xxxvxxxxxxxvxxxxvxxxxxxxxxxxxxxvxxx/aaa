(function(S,a,H,ae,s,i,m,ne,re){"use strict";const{FormInput:w,FormSwitch:F,FormSection:y,FormDivider:_,FormRow:Fe,FormText:E}=ne.Forms,{View:_e,Text:C,ScrollView:ie,TouchableOpacity:I,StyleSheet:oe}=a.ReactNative,l=oe.create({button:{backgroundColor:"#5865F2",padding:12,borderRadius:8,alignItems:"center",marginVertical:8,marginHorizontal:16},successButton:{backgroundColor:"#3BA55D"},dangerButton:{backgroundColor:"#ED4245"},warningButton:{backgroundColor:"#FAA61A"},buttonText:{color:"white",fontWeight:"bold",fontSize:16},infoText:{color:"#B9BBBE",fontSize:14,marginHorizontal:16,marginVertical:8},warningText:{color:"#FAA61A",fontSize:13,marginHorizontal:16,marginVertical:4},codeText:{fontFamily:"monospace",backgroundColor:"#2F3136",padding:8,borderRadius:4,marginHorizontal:16,marginVertical:4,color:"#DCDDDE"}});function P(){return window.__MESSAGE_FAKER__}function ce(){re.useProxy(s.storage);const[e,t]=a.React.useState(""),[n,r]=a.React.useState(""),[o,u]=a.React.useState(""),[f,j]=a.React.useState(""),[K,te]=a.React.useState(""),[A,se]=a.React.useState(""),we=async function(){const c=P();if(!c){i.showToast("\u274C Plugin not ready","Small");return}if(!e.trim()){i.showToast("\u274C Enter target user ID","Small");return}if(!n.trim()){i.showToast("\u274C Enter sender user ID","Small");return}if(!o.trim()&&!f.trim()){i.showToast("\u274C Enter message content or embed","Small");return}const L=f||K||A?{title:f||void 0,description:K||void 0,image:A?{url:A}:void 0,thumbnail:A?{url:A}:void 0,type:"rich"}:void 0;try{await c.fakeMessage({targetUserId:e.trim(),fromUserId:n.trim(),content:o.trim(),embed:L,persistent:!0})&&i.showToast("\u2705 Fake message sent!","Check")}catch{i.showToast("\u274C Failed to send message","Small")}},Ie=async function(){const c=P();if(!c){i.showToast("\u274C Plugin not ready","Small");return}if(!e.trim()||!n.trim()){i.showToast("\u274C Fill in both User IDs first","Small");return}try{await c.quickTest(e.trim(),n.trim())}catch{i.showToast("\u274C Test failed","Small")}},ye=async function(){if(!s.storage.webhookUrl||!s.storage.webhookUrl.trim()){i.showToast("\u274C Enter webhook URL first","Small");return}try{(await fetch(s.storage.webhookUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:"Message Injector Logger",avatar_url:"https://cdn.discordapp.com/embed/avatars/0.png",embeds:[{title:"\u{1F9EA} Webhook Test",description:"If you're seeing this, your webhook is working correctly!",color:3908957,timestamp:new Date().toISOString(),fields:[{name:"Status",value:"\u2705 Connected",inline:!0},{name:"Test Time",value:new Date().toLocaleString(),inline:!0}]}]})})).ok?i.showToast("\u2705 Webhook test successful!","Check"):i.showToast("\u274C Webhook test failed","Small")}catch{i.showToast("\u274C Failed to send test webhook","Small")}},pe=async function(){try{const c=await a.clipboard.getString();c&&(t(c.trim()),i.showToast("\u{1F4CB} Pasted target user ID","clipboard"))}catch{i.showToast("Failed to paste","Small")}},Te=async function(){try{const c=await a.clipboard.getString();c&&(r(c.trim()),i.showToast("\u{1F4CB} Pasted sender user ID","clipboard"))}catch{i.showToast("Failed to paste","Small")}},De=async function(){try{const c=await a.clipboard.getString();c&&(s.storage.webhookUrl=c.trim(),i.showToast("\u{1F4CB} Pasted webhook URL","clipboard"))}catch{i.showToast("Failed to paste","Small")}},ke=a.React.useMemo(function(){return Object.values(s.storage.persistentMessages||{}).reduce(function(c,L){return c+(Array.isArray(L)?L.length:0)},0)},[s.storage.persistentMessages]),Ae=Object.keys(s.storage.persistentMessages||{}).length;return a.React.createElement(ie,null,a.React.createElement(y,{title:"MESSAGE FAKER"},a.React.createElement(E,{style:l.infoText},"\u{1F4AC} Inject fake messages into DMs from anyone."),a.React.createElement(F,{label:"Enable Plugin",subLabel:"Turn the plugin on/off",value:s.storage.enabled,onValueChange:function(c){s.storage.enabled=c,i.showToast(c?"\u2705 Enabled":"\u274C Disabled","Check")}}),a.React.createElement(F,{label:"Auto-Inject on Startup",subLabel:"Automatically show fake messages when Discord starts",value:s.storage.autoInjectOnStartup,onValueChange:function(c){s.storage.autoInjectOnStartup=c}}),a.React.createElement(F,{label:"Prevent Message Deletion",subLabel:"Fake messages can't be deleted (they reinject)",value:s.storage.preventMessageDeletion,onValueChange:function(c){s.storage.preventMessageDeletion=c}}),a.React.createElement(F,{label:"Debug Mode",subLabel:"Enable detailed logging",value:s.storage.debug,onValueChange:function(c){s.storage.debug=c}})),a.React.createElement(_,null),a.React.createElement(y,{title:"\u{1FA9D} WEBHOOK LOGGING"},a.React.createElement(E,{style:l.infoText},"\u{1F4CA} Send detailed logs to a Discord webhook for monitoring all plugin actions"),a.React.createElement(F,{label:"Enable Webhook Logging",subLabel:"Send logs to Discord webhook",value:s.storage.webhookEnabled,onValueChange:function(c){s.storage.webhookEnabled=c,i.showToast(c?"\u2705 Webhook enabled":"\u274C Webhook disabled","Check")}}),a.React.createElement(w,{title:"WEBHOOK URL",placeholder:"https://discord.com/api/webhooks/...",value:s.storage.webhookUrl,onChange:function(c){s.storage.webhookUrl=c}}),a.React.createElement(I,{style:l.button,onPress:De},a.React.createElement(C,{style:l.buttonText},"\u{1F4CB} Paste Webhook URL")),a.React.createElement(I,{style:[l.button,l.successButton],onPress:ye},a.React.createElement(C,{style:l.buttonText},"\u{1F9EA} Test Webhook")),a.React.createElement(E,{style:l.infoText},"\u2139\uFE0F Webhook will log: message creation, injection, deletion prevention, channel switches, and more"),a.React.createElement(E,{style:l.warningText},"\u26A0\uFE0F All actions including user IDs, message IDs, and content will be logged")),a.React.createElement(_,null),a.React.createElement(y,{title:"CREATE FAKE MESSAGE"},a.React.createElement(E,{style:l.infoText},"\u{1F4DD} Create a fake message in someone's DM"),a.React.createElement(w,{title:"TARGET USER ID (Whose DM)",placeholder:"User ID of person whose DM you want to inject into",value:e,onChange:t}),a.React.createElement(I,{style:l.button,onPress:pe},a.React.createElement(C,{style:l.buttonText},"\u{1F4CB} Paste Target User ID")),a.React.createElement(w,{title:"FROM USER ID (Who message is from)",placeholder:"User ID of who the message appears to be from",value:n,onChange:r}),a.React.createElement(I,{style:l.button,onPress:Te},a.React.createElement(C,{style:l.buttonText},"\u{1F4CB} Paste Sender User ID")),a.React.createElement(w,{title:"MESSAGE CONTENT",placeholder:"The message text",value:o,onChange:u}),a.React.createElement(E,{style:l.infoText},"\u{1F4CE} Optional: Add an embed"),a.React.createElement(w,{title:"EMBED TITLE",placeholder:"Optional embed title",value:f,onChange:j}),a.React.createElement(w,{title:"EMBED DESCRIPTION",placeholder:"Optional embed description",value:K,onChange:te}),a.React.createElement(w,{title:"EMBED IMAGE URL",placeholder:"Optional image URL",value:A,onChange:se}),a.React.createElement(I,{style:[l.button,l.successButton],onPress:we},a.React.createElement(C,{style:l.buttonText},"\u2709\uFE0F Send Fake Message")),a.React.createElement(I,{style:[l.button,l.warningButton],onPress:Ie},a.React.createElement(C,{style:l.buttonText},"\u{1F9EA} Quick Test Message"))),a.React.createElement(_,null),a.React.createElement(y,{title:"CONSOLE API"},a.React.createElement(E,{style:l.infoText},"\u{1F527} You can also use the console for advanced usage:"),a.React.createElement(C,{style:l.codeText},`// Send fake message
__MESSAGE_FAKER__.fakeMessage({
  targetUserId: "USER_ID",
  fromUserId: "USER_ID",
  content: "Hello!",
  persistent: true
});`),a.React.createElement(C,{style:l.codeText},`// With embed
__MESSAGE_FAKER__.fakeMessage({
  targetUserId: "USER_ID",
  fromUserId: "USER_ID",
  content: "Check this out!",
  embed: {
    title: "Cool Title",
    description: "Description",
    image: { url: "https://..." }
  }
});`),a.React.createElement(E,{style:l.infoText},"Open Kettu debug console to use these commands")),a.React.createElement(_,null),a.React.createElement(y,{title:"STATISTICS"},a.React.createElement(E,{style:l.infoText},"\u{1F4CA} Current fake messages: ",ke," messages in ",Ae," channels"),a.React.createElement(E,{style:l.infoText},"\u{1FA9D} Webhook logging: ",s.storage.webhookEnabled?"\u2705 Enabled":"\u274C Disabled")),a.React.createElement(_,null),a.React.createElement(y,{title:"DANGER ZONE"},a.React.createElement(I,{style:[l.button,l.dangerButton],onPress:function(){const c=P();c&&c.clearAllMessages(),t(""),r(""),u(""),j(""),te(""),se("")}},a.React.createElement(C,{style:l.buttonText},"\u{1F5D1}\uFE0F Clear ALL Fake Messages")),a.React.createElement(E,{style:l.warningText},"\u26A0\uFE0F This will remove all fake messages from storage. They will disappear on next reload.")),a.React.createElement(E,{style:[l.infoText,{marginTop:16,marginBottom:32,textAlign:"center"}]},"MessageFaker v3.1.0 for Kettu/Bunny/Vendetta (with Webhook Logging)"))}s.storage.enabled??=!0,s.storage.debug??=!1,s.storage.persistentMessages??={},s.storage.autoInjectOnStartup??=!0,s.storage.preventMessageDeletion??=!0,s.storage.testedParameters??={},s.storage.webhookUrl??="",s.storage.webhookEnabled??=!1;const N=[];let p=null,R=null,V=null,T=null,U=null,le=null,x=null,O=null;const b={basicMessageCreate:{tested:!1,works:!1,notificationCount:0},messageCreateWithLocal:{tested:!1,works:!1,notificationCount:0},messageCreateWithSilent:{tested:!1,works:!1,notificationCount:0},messageCreateWithCached:{tested:!1,works:!1,notificationCount:0},loadMessagesSuccess:{tested:!1,works:!1,notificationCount:0},loadMessagesSuccessWithCached:{tested:!1,works:!1,notificationCount:0},channelAckBasic:{tested:!1,works:!1},channelAckWithManual:{tested:!1,works:!1},channelAckWithLocal:{tested:!1,works:!1},channelAckWithBoth:{tested:!1,works:!1}};async function d(e){if(!(!s.storage.webhookEnabled||!s.storage.webhookUrl))try{const t=new Date().toISOString(),n=e.success===!1?15548997:e.success===!0?3908957:5793266,r={title:`\u{1F527} Message Injector - ${e.action}`,color:n,timestamp:t,fields:[]};if(e.details)for(const[o,u]of Object.entries(e.details))r.fields.push({name:o,value:typeof u=="object"?`\`\`\`json
${JSON.stringify(u,null,2).substring(0,1e3)}\`\`\``:`\`${u}\``,inline:o.length<15});e.error&&r.fields.push({name:"\u274C Error",value:`\`\`\`${e.error.substring(0,1e3)}\`\`\``,inline:!1}),await fetch(s.storage.webhookUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:"Message Injector Logger",avatar_url:"https://cdn.discordapp.com/embed/avatars/0.png",embeds:[r]})})}catch(t){g("Failed to send webhook log",t)}}const h=function(e,t){s.storage.debug&&m.logger.log(`[MessageInjector] ${e}`,t||"")},g=function(e,t){m.logger.error(`[MessageInjector] ${e}`,t||"")},v=function(e){return new Promise(function(t){return setTimeout(t,e)})};function de(e){if(!e)return new Date().toISOString();try{const t=new Date(e);return isNaN(t.getTime())?(g("Invalid timestamp, using current time",e),new Date().toISOString()):t.toISOString()}catch(t){return g("Failed to parse timestamp, using current time",t),new Date().toISOString()}}function W(e){return!e||typeof e!="string"?!1:/^\d+$/.test(e.trim())}function ue(e){if(e)try{const t={type:"rich"};return e.title&&typeof e.title=="string"&&(t.title=e.title.substring(0,256)),e.description&&typeof e.description=="string"&&(t.description=e.description.substring(0,4096)),e.image?.url&&typeof e.image.url=="string"&&(t.image={url:e.image.url}),e.thumbnail?.url&&typeof e.thumbnail.url=="string"&&(t.thumbnail={url:e.thumbnail.url}),Object.keys(t).length>1?t:void 0}catch(t){g("Failed to validate embed",t);return}}function D(e,t=[]){for(const n of e)try{const r=H.findByStoreName(n);if(r&&(t.length===0||t.every(function(o){return typeof r[o]=="function"})))return h(`Found store: ${n}`),r}catch{}if(t.length>0)try{const n=H.findByProps(...t);if(n)return h(`Found store by props: ${t.join(", ")}`),n}catch{}return null}async function ge(e){try{if(R){const t=R.getUser?.(e);if(t){const n={username:t.username||"Unknown User",discriminator:t.discriminator||"0",global_name:t.globalName||t.global_name||void 0,avatar:t.avatar?`https://cdn.discordapp.com/avatars/${e}/${t.avatar}.${t.avatar.startsWith("a_")?"gif":"png"}`:null,public_flags:t.publicFlags||t.public_flags||0};if(t.avatarDecorationData||t.avatar_decoration_data){const o=t.avatarDecorationData||t.avatar_decoration_data;n.avatar_decoration_data={asset:o.asset,sku_id:o.skuId||o.sku_id}}else if(t.avatarDecoration||t.avatar_decoration){const o=t.avatarDecoration||t.avatar_decoration;n.avatar_decoration_data={asset:o,sku_id:void 0}}const r=t.clan||t.primaryGuild||t.primary_guild;return r&&(n.clan={identity_guild_id:r.identityGuildId||r.identity_guild_id||null,identity_enabled:r.identityEnabled??r.identity_enabled??!1,tag:r.tag||null,badge:r.badge||null}),n}}}catch(t){g("Failed to get user info",t)}return{username:"Unknown User",discriminator:"0",avatar:null,public_flags:0}}function z(e){try{if(p?.getDMFromUserId){const t=p.getDMFromUserId(e);return h(`DM channel for user ${e}: ${t}`),t}}catch(t){g("Failed to get DM channel",t)}return null}async function J(e){try{let t=z(e);if(!t&&U)try{const n=U.getPrivateChannelIds?.();if(n)for(const r of n){const o=p?.getChannel?.(r);if(o?.type===1&&o.recipients?.includes(e)){t=r;break}}t||(a.FluxDispatcher.dispatch({type:"CHANNEL_SELECT",channelId:null,guildId:null}),await v(100),t=z(e))}catch(n){g("Failed to ensure DM channel",n)}return t}catch(t){return g("Failed to ensure DM channel",t),null}}function Y(){const e=Date.now(),t=Math.floor(Math.random()*4096);return`${e}${t.toString().padStart(4,"0")}`}async function q(e){if(!W(e.userId))throw new Error("Invalid user ID");const t=await ge(e.userId);let n=e.username||t.username,r=e.avatar||t.avatar;const o=de(e.timestamp),u=ue(e.embed),f={id:e.messageId||Y(),channel_id:e.channelId,author:{id:e.userId,username:n||"Unknown User",global_name:t.global_name,discriminator:t.discriminator||"0",avatar:r?r.split("/").pop()?.split(".")[0]:null,avatar_decoration_data:t.avatar_decoration_data,clan:t.clan,public_flags:t.public_flags||0,bot:!1},content:(e.content||"").substring(0,2e3),timestamp:o,edited_timestamp:null,tts:!1,mention_everyone:!1,mentions:[],mention_roles:[],attachments:[],embeds:u?[u]:[],reactions:[],pinned:!1,type:0,flags:0};return h("Created message object",f),await d({action:"Message Created",details:{"Message ID":f.id,"Channel ID":e.channelId,"From User ID":e.userId,Username:n,Content:e.content||"(empty)","Has Embed":u?"Yes":"No",Timestamp:o},success:!0}),f}async function he(e,t){if(!a.FluxDispatcher)return!1;try{switch(t){case"basicMessageCreate":a.FluxDispatcher.dispatch({type:"MESSAGE_CREATE",channelId:e.channel_id,message:e,optimistic:!1});break;case"messageCreateWithLocal":a.FluxDispatcher.dispatch({type:"MESSAGE_CREATE",channelId:e.channel_id,message:e,optimistic:!1,local:!0});break;case"messageCreateWithSilent":a.FluxDispatcher.dispatch({type:"MESSAGE_CREATE",channelId:e.channel_id,message:e,optimistic:!1,silent:!0});break;case"messageCreateWithCached":a.FluxDispatcher.dispatch({type:"MESSAGE_CREATE",channelId:e.channel_id,message:e,optimistic:!1,cached:!0});break;case"loadMessagesSuccess":a.FluxDispatcher.dispatch({type:"LOAD_MESSAGES_SUCCESS",channelId:e.channel_id,messages:[e],isBefore:!1,isAfter:!1});break;case"loadMessagesSuccessWithCached":a.FluxDispatcher.dispatch({type:"LOAD_MESSAGES_SUCCESS",channelId:e.channel_id,messages:[e],isBefore:!1,isAfter:!1,cached:!0});break;default:return!1}return h(`Tested injection method: ${t}`),await d({action:`Test Injection - ${t}`,details:{Method:t,"Message ID":e.id,"Channel ID":e.channel_id},success:!0}),!0}catch(n){return g(`Failed to test ${t}`,n),await d({action:`Test Injection Failed - ${t}`,details:{Method:t,"Message ID":e.id},success:!1,error:String(n)}),!1}}async function fe(e,t,n){if(!a.FluxDispatcher)return!1;try{switch(n){case"channelAckBasic":a.FluxDispatcher.dispatch({type:"CHANNEL_ACK",channelId:e,messageId:t});break;case"channelAckWithManual":a.FluxDispatcher.dispatch({type:"CHANNEL_ACK",channelId:e,messageId:t,manual:!0});break;case"channelAckWithLocal":a.FluxDispatcher.dispatch({type:"CHANNEL_ACK",channelId:e,messageId:t,local:!0});break;case"channelAckWithBoth":a.FluxDispatcher.dispatch({type:"CHANNEL_ACK",channelId:e,messageId:t,manual:!0,local:!0});break;default:return!1}return h(`Tested ACK method: ${n}`),await d({action:`Test ACK - ${n}`,details:{Method:n,"Channel ID":e,"Message ID":t},success:!0}),!0}catch(r){return g(`Failed to test ${n}`,r),await d({action:`Test ACK Failed - ${n}`,details:{Method:n,"Channel ID":e},success:!1,error:String(r)}),!1}}function B(e){if(!a.FluxDispatcher)return g("FluxDispatcher not available"),!1;try{const t=Ee();return t==="loadMessagesSuccess"?a.FluxDispatcher.dispatch({type:"LOAD_MESSAGES_SUCCESS",channelId:e.channel_id,messages:[e],isBefore:!1,isAfter:!1}):t==="loadMessagesSuccessWithCached"?a.FluxDispatcher.dispatch({type:"LOAD_MESSAGES_SUCCESS",channelId:e.channel_id,messages:[e],isBefore:!1,isAfter:!1,cached:!0}):a.FluxDispatcher.dispatch({type:"MESSAGE_CREATE",channelId:e.channel_id,message:e,optimistic:!1}),h("Message injected successfully",e.id),d({action:"Message Injected",details:{Method:t,"Message ID":e.id,"Channel ID":e.channel_id,"Author ID":e.author.id,"Content Preview":e.content.substring(0,100)},success:!0}),!0}catch(t){return g("Failed to inject message",t),d({action:"Message Injection Failed",details:{"Message ID":e.id,"Channel ID":e.channel_id},success:!1,error:String(t)}),!1}}function Ee(){const e=Object.entries(b).filter(function([t,n]){return n.tested&&n.works&&t.includes("message")||t.includes("load")}).sort(function(t,n){const r=t[1].notificationCount||0,o=n[1].notificationCount||0;return r-o});return e.length>0?e[0][0]:"basicMessageCreate"}function k(){try{typeof s.storage.persistentMessages!="object"&&(s.storage.persistentMessages={}),Object.keys(s.storage.persistentMessages).forEach(function(e){Array.isArray(s.storage.persistentMessages[e])||delete s.storage.persistentMessages[e]}),s.storage.persistentMessages=JSON.parse(JSON.stringify(s.storage.persistentMessages)),s.storage.testedParameters=b,h("Saved persistent messages and test results")}catch(e){g("Failed to save persistent messages",e),s.storage.persistentMessages={}}}async function $(e){try{if(!W(e.fromUserId))return g("Invalid sender user ID"),i.showToast&&i.showToast("\u274C Invalid sender user ID","Small"),await d({action:"Fake Message Failed",details:{Reason:"Invalid sender user ID","From User ID":e.fromUserId},success:!1}),!1;let t=e.channelId;if(!t&&e.targetUserId){if(!W(e.targetUserId))return g("Invalid target user ID"),i.showToast&&i.showToast("\u274C Invalid target user ID","Small"),await d({action:"Fake Message Failed",details:{Reason:"Invalid target user ID","Target User ID":e.targetUserId},success:!1}),!1;t=await J(e.targetUserId)}if(!t)return g("No valid channel ID found"),i.showToast&&i.showToast("\u274C Could not find DM channel","Small"),await d({action:"Fake Message Failed",details:{Reason:"No valid channel ID found","Target User ID":e.targetUserId||"N/A"},success:!1}),!1;const n=await q({channelId:t,userId:e.fromUserId,content:e.content,username:e.username,avatar:e.avatar,embed:e.embed});e.persistent&&(s.storage.persistentMessages[t]||(s.storage.persistentMessages[t]=[]),new Set(s.storage.persistentMessages[t].map(function(o){return o.id})).has(n.id)||s.storage.persistentMessages[t].push(n),k(),h("Message saved to persistent storage",n.id),await d({action:"Message Saved to Storage",details:{"Message ID":n.id,"Channel ID":t,Persistent:"Yes"},success:!0}));const r=B(n);return r&&h("Fake message sent successfully"),r}catch(t){return g("Failed to send fake message",t),i.showToast&&i.showToast("\u274C Failed to send message","Small"),await d({action:"Fake Message Failed",success:!1,error:String(t)}),!1}}function M(e){if(!s.storage.persistentMessages[e])return;const t=s.storage.persistentMessages[e];if(!Array.isArray(t)){delete s.storage.persistentMessages[e],k();return}h(`Reinjecting ${t.length} messages for channel ${e}`),d({action:"Messages Reinjected",details:{"Channel ID":e,"Message Count":t.length},success:!0}),t.forEach(function(n,r){setTimeout(function(){try{B(n)}catch(o){g("Failed to reinject message",o)}},r*50)})}function be(){try{if(!a.FluxDispatcher)return;const e=ae.before("dispatch",a.FluxDispatcher,function(t){if(!s.storage.enabled)return;const n=t[0];if(!(!n||!n.type)){if(s.storage.preventMessageDeletion&&n.type==="MESSAGE_DELETE"){const r=n.id,o=n.channelId;if(o&&s.storage.persistentMessages[o]){const u=s.storage.persistentMessages[o].find(function(f){return f.id===r});u&&(h("Prevented deletion of fake message",r),t[0]={type:"NOOP"},setTimeout(function(){return B(u)},100),d({action:"Message Deletion Prevented",details:{"Message ID":r,"Channel ID":o},success:!0}))}}if(s.storage.preventMessageDeletion&&n.type==="MESSAGE_DELETE_BULK"){const r=n.channelId;if(r&&s.storage.persistentMessages[r]){const o=n.ids||[];s.storage.persistentMessages[r].some(function(u){return o.includes(u.id)})&&(t[0]={type:"NOOP"},setTimeout(function(){return M(r)},200),d({action:"Bulk Deletion Prevented",details:{"Channel ID":r,"Message IDs":o.join(", ")},success:!0}))}}if(n.type==="CHANNEL_SELECT"){const r=n.channelId;r&&s.storage.persistentMessages[r]&&setTimeout(function(){return M(r)},300)}if(n.type==="LOAD_MESSAGES_SUCCESS"||n.type==="LOAD_MESSAGES"||n.type==="LOCAL_MESSAGES_LOADED"){const r=n.channelId;r&&s.storage.persistentMessages[r]&&setTimeout(function(){return M(r)},500)}if(n.type==="MESSAGE_UPDATE"){const r=n.message?.channel_id,o=n.message?.id;if(r&&o&&s.storage.persistentMessages[r]){const u=s.storage.persistentMessages[r];Array.isArray(u)&&(u.some(function(f){return f&&f.id===o})||setTimeout(function(){return M(r)},100))}}if((n.type==="CHANNEL_UPDATES"||n.type==="CACHE_LOADED"||n.type==="OVERLAY_INITIALIZE"||n.type==="CONNECTION_OPEN")&&T){const r=T.getChannelId?.();r&&s.storage.persistentMessages[r]&&setTimeout(function(){return M(r)},600)}}});N.push(e),h("Message persistence system setup")}catch(e){g("Failed to setup message persistence",e)}}function Se(){O=setInterval(function(){if(T)try{const e=T.getChannelId?.();if(e&&e!==x){const t=x;x=e,h(`Channel switched from ${t} to ${e}`),d({action:"Channel Switched",details:{"Previous Channel":t||"None","New Channel":e}}),s.storage.persistentMessages[e]&&setTimeout(function(){M(e)},300)}}catch{}},1e3)}function Q(){const e=Object.values(s.storage.persistentMessages).reduce(function(t,n){return t+n.length},0);s.storage.persistentMessages={},k(),h("Cleared all persistent messages"),d({action:"All Messages Cleared",details:{"Messages Cleared":e},success:!0}),i.showToast&&i.showToast("\u2705 All fake messages cleared","Check")}function Z(e){if(s.storage.persistentMessages[e]){const t=s.storage.persistentMessages[e].length;delete s.storage.persistentMessages[e],k(),h(`Cleared messages for channel ${e}`),d({action:"Channel Messages Cleared",details:{"Channel ID":e,"Messages Cleared":t},success:!0}),i.showToast&&i.showToast("\u2705 Channel messages cleared","Check")}}function X(){return s.storage.persistentMessages}async function ee(e,t){return await d({action:"Quick Test Started",details:{"Target User ID":e,"From User ID":t}}),await $({targetUserId:e,fromUserId:t,content:"Test message from Message Injector plugin! \u{1F389}",persistent:!0})}async function G(e,t){h("Starting parameter tests..."),await d({action:"Parameter Tests Started",details:{"Target User ID":e,"From User ID":t}});const n=await J(e);if(!n){g("Cannot run tests: No DM channel"),i.showToast&&i.showToast("\u274C Cannot run tests: No DM channel","Small"),await d({action:"Parameter Tests Failed",success:!1,error:"No DM channel found"});return}const r=await q({channelId:n,userId:t,content:"\u{1F9EA} Testing injection parameters...",username:"Test Bot"});for(const u of["basicMessageCreate","messageCreateWithLocal","messageCreateWithSilent","messageCreateWithCached","loadMessagesSuccess","loadMessagesSuccessWithCached"]){const f={...r,id:Y(),content:`\u{1F9EA} Test: ${u}`},j=await he(f,u);b[u].tested=!0,b[u].works=j,await v(1e3)}const o=r.id;for(const u of["channelAckBasic","channelAckWithManual","channelAckWithLocal","channelAckWithBoth"]){const f=await fe(n,o,u);b[u].tested=!0,b[u].works=f,await v(500)}k(),h("Parameter tests complete",b),await d({action:"Parameter Tests Complete",details:{"Test Results":b},success:!0}),i.showToast&&i.showToast("\u2705 Tests complete! Check console for results","Check")}async function Ce(){try{p=D(["ChannelStore"],["getChannel","getDMFromUserId"]),R=D(["UserStore","CurrentUserStore"],["getUser","getCurrentUser"]),V=D(["MessageStore"],["getMessages","getMessage"]),T=D(["SelectedChannelStore"],["getChannelId"]),U=D(["PrivateChannelStore"],["getPrivateChannelIds"]),le=D(["RelationshipStore"],["getRelationships"]);const e=p&&R;return e?(h("All critical modules loaded"),await d({action:"Modules Initialized",details:{ChannelStore:p?"\u2705":"\u274C",UserStore:R?"\u2705":"\u274C",MessageStore:V?"\u2705":"\u274C",SelectedChannelStore:T?"\u2705":"\u274C",PrivateChannelStore:U?"\u2705":"\u274C"},success:!0})):(g("Some modules failed to load"),await d({action:"Module Initialization Failed",success:!1,error:"Critical modules missing"})),e}catch(e){return g("Failed to initialize modules",e),await d({action:"Module Initialization Error",success:!1,error:String(e)}),!1}}function Me(){try{if(typeof s.storage.persistentMessages!="object"||s.storage.persistentMessages===null){m.logger.warn("[MessageInjector] Corrupted storage detected, resetting..."),s.storage.persistentMessages={};return}Object.keys(s.storage.persistentMessages).forEach(function(e){Array.isArray(s.storage.persistentMessages[e])?(s.storage.persistentMessages[e]=s.storage.persistentMessages[e].filter(function(t){return t&&t.id&&t.channel_id&&t.author&&t.timestamp}),s.storage.persistentMessages[e].length===0&&delete s.storage.persistentMessages[e]):delete s.storage.persistentMessages[e]}),k()}catch(e){g("Failed to recover storage",e),s.storage.persistentMessages={}}}var me={onLoad:async function(){try{if(m.logger.log("[MessageInjector] Loading (Self-Testing Edition with Webhook Logging)..."),Me(),s.storage.testedParameters&&(Object.assign(b,s.storage.testedParameters),h("Loaded previous test results",b)),await v(1e3),!await Ce()){g("Failed to load critical modules"),i.showToast&&i.showToast("\u274C Plugin failed to load","Small"),await d({action:"Plugin Load Failed",success:!1,error:"Critical modules not ready"});return}if(be(),Se(),s.storage.autoInjectOnStartup){await v(2e3);const e=Object.keys(s.storage.persistentMessages).length;e>0&&(h(`Auto-injecting messages for ${e} channels on startup`),await d({action:"Auto-Inject on Startup",details:{"Channel Count":e}}),Object.keys(s.storage.persistentMessages).forEach(function(t){setTimeout(function(){M(t)},500)}))}window.__MESSAGE_FAKER__={fakeMessage:$,clearAllMessages:Q,clearChannelMessages:Z,getAllMessages:X,quickTest:ee,runParameterTests:G,reinjectChannel:function(e){return M(e)},reinjectAll:function(){Object.keys(s.storage.persistentMessages).forEach(function(e){M(e)})},getStatus:function(){return{enabled:s.storage.enabled,messageCount:Object.values(s.storage.persistentMessages).reduce(function(e,t){return e+t.length},0),channelCount:Object.keys(s.storage.persistentMessages).length,testResults:b,webhookEnabled:s.storage.webhookEnabled}},getTestResults:function(){return b},testInjection:async function(e,t){await G(e,t)}},await d({action:"Plugin Loaded Successfully",details:{Version:"3.1.0","Webhook Enabled":s.storage.webhookEnabled?"Yes":"No"},success:!0}),m.logger.log("[MessageInjector] \u2705 Loaded successfully (Self-Testing Edition with Webhook Logging)"),m.logger.log("[MessageInjector] Use __MESSAGE_FAKER__.testInjection(targetUserId, fromUserId) to test parameters")}catch(e){g("Fatal error during load",e),i.showToast&&i.showToast("\u274C Plugin failed to load","Small"),await d({action:"Plugin Load Error",success:!1,error:String(e)})}},onUnload:function(){try{for(const e of N)try{e()}catch{}N.length=0,O&&(clearInterval(O),O=null),window.__MESSAGE_FAKER__&&delete window.__MESSAGE_FAKER__,d({action:"Plugin Unloaded",success:!0}),m.logger.log("[MessageInjector] Unloaded"),i.showToast&&i.showToast("Plugin unloaded","Check")}catch(e){g("Error during unload",e)}},settings:ce};return S.clearAllMessages=Q,S.clearChannelMessages=Z,S.default=me,S.fakeMessage=$,S.getAllMessages=X,S.quickTest=ee,S.runParameterTests=G,Object.defineProperty(S,"__esModule",{value:!0}),S})({},vendetta.metro.common,vendetta.metro,vendetta.patcher,vendetta.plugin,vendetta.ui.toasts,vendetta,vendetta.ui.components,vendetta.storage);
