(function(h,s,K,Z,a,o,y,X,ee){"use strict";const{FormInput:M,FormSwitch:v,FormSection:T,FormDivider:D,FormRow:we,FormText:E}=X.Forms,{View:Ce,Text:m,ScrollView:te,TouchableOpacity:I,StyleSheet:ae}=s.ReactNative,c=ae.create({button:{backgroundColor:"#5865F2",padding:12,borderRadius:8,alignItems:"center",marginVertical:8,marginHorizontal:16},successButton:{backgroundColor:"#3BA55D"},dangerButton:{backgroundColor:"#ED4245"},warningButton:{backgroundColor:"#FAA61A"},buttonText:{color:"white",fontWeight:"bold",fontSize:16},infoText:{color:"#B9BBBE",fontSize:14,marginHorizontal:16,marginVertical:8},warningText:{color:"#FAA61A",fontSize:13,marginHorizontal:16,marginVertical:4},codeText:{fontFamily:"monospace",backgroundColor:"#2F3136",padding:8,borderRadius:4,marginHorizontal:16,marginVertical:4,color:"#DCDDDE"}});function k(){return window.__MESSAGE_FAKER__}function se(){ee.useProxy(a.storage);const[e,t]=s.React.useState(""),[n,r]=s.React.useState(""),[l,g]=s.React.useState(""),[f,J]=s.React.useState(""),[G,Q]=s.React.useState(""),[S,Y]=s.React.useState(""),Me=async function(){const i=k();if(!i){o.showToast("\u274C Plugin not ready","Small");return}if(!e.trim()){o.showToast("\u274C Enter target user ID","Small");return}if(!n.trim()){o.showToast("\u274C Enter sender user ID","Small");return}if(!l.trim()&&!f.trim()){o.showToast("\u274C Enter message content or embed","Small");return}const A=f||G||S?{title:f||void 0,description:G||void 0,image:S?{url:S}:void 0,thumbnail:S?{url:S}:void 0,type:"rich"}:void 0;try{await i.fakeMessage({targetUserId:e.trim(),fromUserId:n.trim(),content:l.trim(),embed:A,persistent:!0})&&o.showToast("\u2705 Fake message sent!","Check")}catch{o.showToast("\u274C Failed to send message","Small")}},be=async function(){const i=k();if(!i){o.showToast("\u274C Plugin not ready","Small");return}if(!e.trim()||!n.trim()){o.showToast("\u274C Fill in both User IDs first","Small");return}try{await i.quickTest(e.trim(),n.trim())}catch{o.showToast("\u274C Test failed","Small")}},pe=async function(){try{const i=await s.clipboard.getString();i&&(t(i.trim()),o.showToast("\u{1F4CB} Pasted target user ID","clipboard"))}catch{o.showToast("Failed to paste","Small")}},Se=async function(){try{const i=await s.clipboard.getString();i&&(r(i.trim()),o.showToast("\u{1F4CB} Pasted sender user ID","clipboard"))}catch{o.showToast("Failed to paste","Small")}},Te=s.React.useMemo(function(){return Object.values(a.storage.persistentMessages||{}).reduce(function(i,A){return i+(Array.isArray(A)?A.length:0)},0)},[a.storage.persistentMessages]),Ie=Object.keys(a.storage.persistentMessages||{}).length;return s.React.createElement(te,null,s.React.createElement(T,{title:"MESSAGE FAKER"},s.React.createElement(E,{style:c.infoText},"\u{1F4AC} Inject fake messages into DMs from anyone."),s.React.createElement(v,{label:"Enable Plugin",subLabel:"Turn the plugin on/off",value:a.storage.enabled,onValueChange:function(i){a.storage.enabled=i,o.showToast(i?"\u2705 Enabled":"\u274C Disabled","Check")}}),s.React.createElement(v,{label:"Auto-Inject on Startup",subLabel:"Automatically show fake messages when Discord starts",value:a.storage.autoInjectOnStartup,onValueChange:function(i){a.storage.autoInjectOnStartup=i}}),s.React.createElement(v,{label:"Prevent Message Deletion",subLabel:"Fake messages can't be deleted (they reinject)",value:a.storage.preventMessageDeletion,onValueChange:function(i){a.storage.preventMessageDeletion=i}}),s.React.createElement(v,{label:"Debug Mode",subLabel:"Enable detailed logging",value:a.storage.debug,onValueChange:function(i){a.storage.debug=i}})),s.React.createElement(D,null),s.React.createElement(T,{title:"CREATE FAKE MESSAGE"},s.React.createElement(E,{style:c.infoText},"\u{1F4DD} Create a fake message in someone's DM"),s.React.createElement(M,{title:"TARGET USER ID (Whose DM)",placeholder:"User ID of person whose DM you want to inject into",value:e,onChange:t}),s.React.createElement(I,{style:c.button,onPress:pe},s.React.createElement(m,{style:c.buttonText},"\u{1F4CB} Paste Target User ID")),s.React.createElement(M,{title:"FROM USER ID (Who message is from)",placeholder:"User ID of who the message appears to be from",value:n,onChange:r}),s.React.createElement(I,{style:c.button,onPress:Se},s.React.createElement(m,{style:c.buttonText},"\u{1F4CB} Paste Sender User ID")),s.React.createElement(M,{title:"MESSAGE CONTENT",placeholder:"The message text",value:l,onChange:g}),s.React.createElement(E,{style:c.infoText},"\u{1F4CE} Optional: Add an embed"),s.React.createElement(M,{title:"EMBED TITLE",placeholder:"Optional embed title",value:f,onChange:J}),s.React.createElement(M,{title:"EMBED DESCRIPTION",placeholder:"Optional embed description",value:G,onChange:Q}),s.React.createElement(M,{title:"EMBED IMAGE URL",placeholder:"Optional image URL",value:S,onChange:Y}),s.React.createElement(I,{style:[c.button,c.successButton],onPress:Me},s.React.createElement(m,{style:c.buttonText},"\u2709\uFE0F Send Fake Message")),s.React.createElement(I,{style:[c.button,c.warningButton],onPress:be},s.React.createElement(m,{style:c.buttonText},"\u{1F9EA} Quick Test Message"))),s.React.createElement(D,null),s.React.createElement(T,{title:"CONSOLE API"},s.React.createElement(E,{style:c.infoText},"\u{1F527} You can also use the console for advanced usage:"),s.React.createElement(m,{style:c.codeText},`// Send fake message
__MESSAGE_FAKER__.fakeMessage({
  targetUserId: "USER_ID",
  fromUserId: "USER_ID",
  content: "Hello!",
  persistent: true
});`),s.React.createElement(m,{style:c.codeText},`// With embed
__MESSAGE_FAKER__.fakeMessage({
  targetUserId: "USER_ID",
  fromUserId: "USER_ID",
  content: "Check this out!",
  embed: {
    title: "Cool Title",
    description: "Description",
    image: { url: "https://..." }
  }
});`),s.React.createElement(E,{style:c.infoText},"Open Kettu debug console to use these commands")),s.React.createElement(D,null),s.React.createElement(T,{title:"STATISTICS"},s.React.createElement(E,{style:c.infoText},"\u{1F4CA} Current fake messages: ",Te," messages in ",Ie," channels")),s.React.createElement(D,null),s.React.createElement(T,{title:"DANGER ZONE"},s.React.createElement(I,{style:[c.button,c.dangerButton],onPress:function(){const i=k();i&&i.clearAllMessages(),t(""),r(""),g(""),J(""),Q(""),Y("")}},s.React.createElement(m,{style:c.buttonText},"\u{1F5D1}\uFE0F Clear ALL Fake Messages")),s.React.createElement(E,{style:c.warningText},"\u26A0\uFE0F This will remove all fake messages from storage. They will disappear on next reload.")),s.React.createElement(E,{style:[c.infoText,{marginTop:16,marginBottom:32,textAlign:"center"}]},"MessageFaker v1.0.2 for Kettu/Bunny/Vendetta"))}a.storage.enabled??=!0,a.storage.debug??=!1,a.storage.persistentMessages??={},a.storage.autoInjectOnStartup??=!0,a.storage.preventMessageDeletion??=!0;const U=[];let w=null,_=null,ne=null,O=null,j=null,re=null,P=null,F=null;const R={},oe=3e3;let x=!1;const d=function(e,t){a.storage.debug&&y.logger.log(`[MessageInjector] ${e}`,t||"")},u=function(e,t){y.logger.error(`[MessageInjector] ${e}`,t||"")},$=function(e){return new Promise(function(t){return setTimeout(t,e)})};function ie(e){if(!e)return new Date().toISOString();try{const t=new Date(e);return isNaN(t.getTime())?(u("Invalid timestamp, using current time",e),new Date().toISOString()):t.toISOString()}catch(t){return u("Failed to parse timestamp, using current time",t),new Date().toISOString()}}function B(e){return!e||typeof e!="string"?!1:/^\d+$/.test(e.trim())}function le(e){if(e)try{const t={type:"rich"};return e.title&&typeof e.title=="string"&&(t.title=e.title.substring(0,256)),e.description&&typeof e.description=="string"&&(t.description=e.description.substring(0,4096)),e.image?.url&&typeof e.image.url=="string"&&(t.image={url:e.image.url}),e.thumbnail?.url&&typeof e.thumbnail.url=="string"&&(t.thumbnail={url:e.thumbnail.url}),Object.keys(t).length>1?t:void 0}catch(t){u("Failed to validate embed",t);return}}function b(e,t=[]){for(const n of e)try{const r=K.findByStoreName(n);if(r&&(t.length===0||t.every(function(l){return typeof r[l]=="function"})))return d(`Found store: ${n}`),r}catch{}if(t.length>0)try{const n=K.findByProps(...t);if(n)return d(`Found store by props: ${t.join(", ")}`),n}catch{}return null}async function ce(e){try{if(_){const t=_.getUser?.(e);if(t){const n={username:t.username||"Unknown User",discriminator:t.discriminator||"0",global_name:t.globalName||t.global_name||void 0,avatar:t.avatar?`https://cdn.discordapp.com/avatars/${e}/${t.avatar}.${t.avatar.startsWith("a_")?"gif":"png"}`:null,public_flags:t.publicFlags||t.public_flags||0};if(t.avatarDecorationData||t.avatar_decoration_data){const l=t.avatarDecorationData||t.avatar_decoration_data;n.avatar_decoration_data={asset:l.asset,sku_id:l.skuId||l.sku_id}}else if(t.avatarDecoration||t.avatar_decoration){const l=t.avatarDecoration||t.avatar_decoration;n.avatar_decoration_data={asset:l,sku_id:void 0}}const r=t.clan||t.primaryGuild||t.primary_guild;return r&&(n.clan={identity_guild_id:r.identityGuildId||r.identity_guild_id||null,identity_enabled:r.identityEnabled??r.identity_enabled??!1,tag:r.tag||null,badge:r.badge||null}),n}}}catch(t){u("Failed to get user info",t)}return{username:"Unknown User",discriminator:"0",avatar:null,public_flags:0}}function V(e){try{if(w?.getDMFromUserId){const t=w.getDMFromUserId(e);return d(`DM channel for user ${e}: ${t}`),t}}catch(t){u("Failed to get DM channel",t)}return null}async function ue(e){try{let t=V(e);if(!t&&j)try{const n=j.getPrivateChannelIds?.();if(n)for(const r of n){const l=w?.getChannel?.(r);if(l?.type===1&&l.recipients?.includes(e)){t=r;break}}t||(s.FluxDispatcher.dispatch({type:"CHANNEL_SELECT",channelId:null,guildId:null}),await $(100),t=V(e))}catch(n){u("Failed to ensure DM channel",n)}return t}catch(t){return u("Failed to ensure DM channel",t),null}}function de(){const e=Date.now(),t=Math.floor(Math.random()*4096);return`${e}${t.toString().padStart(4,"0")}`}async function ge(e){if(!B(e.userId))throw new Error("Invalid user ID");const t=await ce(e.userId);let n=e.username||t.username,r=e.avatar||t.avatar;const l=ie(e.timestamp),g=le(e.embed),f={id:e.messageId||de(),channel_id:e.channelId,author:{id:e.userId,username:n||"Unknown User",global_name:t.global_name,discriminator:t.discriminator||"0",avatar:r?r.split("/").pop()?.split(".")[0]:null,avatar_decoration_data:t.avatar_decoration_data,clan:t.clan,public_flags:t.public_flags||0,bot:!1},content:(e.content||"").substring(0,2e3),timestamp:l,edited_timestamp:null,tts:!1,mention_everyone:!1,mentions:[],mention_roles:[],attachments:[],embeds:g?[g]:[],reactions:[],pinned:!1,type:0,flags:0};return d("Created message object",f),f}function N(e,t=!1){if(!s.FluxDispatcher)return u("FluxDispatcher not available"),!1;try{return s.FluxDispatcher.dispatch({type:"MESSAGE_CREATE",channelId:e.channel_id,message:e,optimistic:!1,sendMessageOptions:{},isPushNotification:!1,...t&&{silent:!0,local:!0}}),d(`Message ${t?"silently ":""}injected successfully`,e.id),!0}catch(n){return u("Failed to inject message",n),!1}}function C(){try{typeof a.storage.persistentMessages!="object"&&(a.storage.persistentMessages={}),Object.keys(a.storage.persistentMessages).forEach(function(e){Array.isArray(a.storage.persistentMessages[e])||delete a.storage.persistentMessages[e]}),a.storage.persistentMessages=JSON.parse(JSON.stringify(a.storage.persistentMessages)),d("Saved persistent messages",Object.keys(a.storage.persistentMessages).length)}catch(e){u("Failed to save persistent messages",e),a.storage.persistentMessages={}}}async function L(e){try{if(!B(e.fromUserId))return u("Invalid sender user ID"),o.showToast&&o.showToast("\u274C Invalid sender user ID","Small"),!1;let t=e.channelId;if(!t&&e.targetUserId){if(!B(e.targetUserId))return u("Invalid target user ID"),o.showToast&&o.showToast("\u274C Invalid target user ID","Small"),!1;t=await ue(e.targetUserId)}if(!t)return u("No valid channel ID found"),o.showToast&&o.showToast("\u274C Could not find DM channel","Small"),!1;const n=await ge({channelId:t,userId:e.fromUserId,content:e.content,username:e.username,avatar:e.avatar,embed:e.embed});e.persistent&&(a.storage.persistentMessages[t]||(a.storage.persistentMessages[t]=[]),a.storage.persistentMessages[t].push(n),C(),d("Message saved to persistent storage",n.id));const r=N(n,!1);return r&&d("Fake message sent successfully"),r}catch(t){return u("Failed to send fake message",t),o.showToast&&o.showToast("\u274C Failed to send message","Small"),!1}}function p(e,t=!1){if(!a.storage.persistentMessages[e])return;const n=Date.now();if(!t&&R[e]&&n-R[e]<oe){d(`Skipping reinject for ${e} - too soon (${n-R[e]}ms ago)`);return}const r=a.storage.persistentMessages[e];if(!Array.isArray(r)){delete a.storage.persistentMessages[e],C();return}d(`Reinjecting ${r.length} messages for channel ${e}`),R[e]=n,r.forEach(function(l,g){setTimeout(function(){try{N(l,!0)}catch(f){u("Failed to reinject message",f)}},g*50)})}function fe(){try{if(!s.FluxDispatcher)return;const e=Z.before("dispatch",s.FluxDispatcher,function(t){if(!a.storage.enabled)return;const n=t[0];if(!(!n||!n.type)){if(a.storage.preventMessageDeletion&&n.type==="MESSAGE_DELETE"){const r=n.id,l=n.channelId;if(l&&a.storage.persistentMessages[l]){const g=a.storage.persistentMessages[l].find(function(f){return f.id===r});g&&(d("Prevented deletion of fake message",r),t[0]={type:"NOOP"},setTimeout(function(){return N(g,!0)},100))}}if(a.storage.preventMessageDeletion&&n.type==="MESSAGE_DELETE_BULK"){const r=n.channelId;if(r&&a.storage.persistentMessages[r]){const l=n.ids||[];a.storage.persistentMessages[r].some(function(g){return l.includes(g.id)})&&(t[0]={type:"NOOP"},setTimeout(function(){return p(r,!0)},200))}}if(n.type==="LOAD_MESSAGES_SUCCESS"){const r=n.channelId;r&&a.storage.persistentMessages[r]&&setTimeout(function(){return p(r)},500)}n.type==="CONNECTION_OPEN"&&x&&Object.keys(a.storage.persistentMessages).forEach(function(r){setTimeout(function(){p(r,!0)},1e3)})}});U.push(e),d("Message persistence system setup with minimal event coverage")}catch(e){u("Failed to setup message persistence",e)}}function he(){F=setInterval(function(){if(O)try{const e=O.getChannelId?.();if(e&&e!==P){const t=P;P=e,d(`Channel switched from ${t} to ${e}`),a.storage.persistentMessages[e]&&setTimeout(function(){p(e)},300)}}catch{}},1e3)}function z(){a.storage.persistentMessages={},C(),d("Cleared all persistent messages"),o.showToast&&o.showToast("\u2705 All fake messages cleared","Check")}function H(e){a.storage.persistentMessages[e]&&(delete a.storage.persistentMessages[e],C(),d(`Cleared messages for channel ${e}`),o.showToast&&o.showToast("\u2705 Channel messages cleared","Check"))}function W(){return a.storage.persistentMessages}async function q(e,t){return await L({targetUserId:e,fromUserId:t,content:"Test message from Message Injector plugin! \u{1F389}",persistent:!0})}async function Ee(){try{w=b(["ChannelStore"],["getChannel","getDMFromUserId"]),_=b(["UserStore","CurrentUserStore"],["getUser","getCurrentUser"]),ne=b(["MessageStore"],["getMessages","getMessage"]),O=b(["SelectedChannelStore"],["getChannelId"]),j=b(["PrivateChannelStore"],["getPrivateChannelIds"]),re=b(["RelationshipStore"],["getRelationships"]);const e=w&&_;return e?d("All critical modules loaded"):u("Some modules failed to load"),e}catch(e){return u("Failed to initialize modules",e),!1}}function me(){try{if(typeof a.storage.persistentMessages!="object"||a.storage.persistentMessages===null){y.logger.warn("[MessageInjector] Corrupted storage detected, resetting..."),a.storage.persistentMessages={};return}Object.keys(a.storage.persistentMessages).forEach(function(e){Array.isArray(a.storage.persistentMessages[e])?(a.storage.persistentMessages[e]=a.storage.persistentMessages[e].filter(function(t){return t&&t.id&&t.channel_id&&t.author&&t.timestamp}),a.storage.persistentMessages[e].length===0&&delete a.storage.persistentMessages[e]):delete a.storage.persistentMessages[e]}),C()}catch(e){u("Failed to recover storage",e),a.storage.persistentMessages={}}}var ye={onLoad:async function(){try{if(y.logger.log("[MessageInjector] Loading..."),me(),await $(1e3),!await Ee()){u("Failed to load critical modules"),o.showToast&&o.showToast("\u274C Plugin failed to load","Small");return}if(fe(),he(),a.storage.autoInjectOnStartup){await $(2e3);const e=Object.keys(a.storage.persistentMessages).length;e>0&&(d(`Auto-injecting messages for ${e} channels on startup`),Object.keys(a.storage.persistentMessages).forEach(function(t){setTimeout(function(){p(t,!0)},500)})),setTimeout(function(){x=!0,d("Startup injection complete")},3e3)}else x=!0;window.__MESSAGE_FAKER__={fakeMessage:L,clearAllMessages:z,clearChannelMessages:H,getAllMessages:W,quickTest:q,reinjectChannel:function(e){return p(e,!0)},getStatus:function(){return{enabled:a.storage.enabled,messageCount:Object.values(a.storage.persistentMessages).reduce(function(e,t){return e+t.length},0),channelCount:Object.keys(a.storage.persistentMessages).length}}},y.logger.log("[MessageInjector] \u2705 Loaded successfully")}catch(e){u("Fatal error during load",e),o.showToast&&o.showToast("\u274C Plugin failed to load","Small")}},onUnload:function(){try{for(const e of U)try{e()}catch{}U.length=0,F&&(clearInterval(F),F=null),window.__MESSAGE_FAKER__&&delete window.__MESSAGE_FAKER__,y.logger.log("[MessageInjector] Unloaded"),o.showToast&&o.showToast("Plugin unloaded","Check")}catch(e){u("Error during unload",e)}},settings:se};return h.clearAllMessages=z,h.clearChannelMessages=H,h.default=ye,h.fakeMessage=L,h.getAllMessages=W,h.quickTest=q,Object.defineProperty(h,"__esModule",{value:!0}),h})({},vendetta.metro.common,vendetta.metro,vendetta.patcher,vendetta.plugin,vendetta.ui.toasts,vendetta,vendetta.ui.components,vendetta.storage);
