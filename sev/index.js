(function(C,a,ue,Ae,n,i,I,Fe,Ie){"use strict";const{FormInput:E,FormSwitch:$,FormSection:T,FormDivider:A,FormRow:tt,FormText:m}=Fe.Forms,{View:at,Text:S,ScrollView:_e,TouchableOpacity:R,StyleSheet:De}=a.ReactNative,o=De.create({button:{backgroundColor:"#5865F2",padding:12,borderRadius:8,alignItems:"center",marginVertical:8,marginHorizontal:16},successButton:{backgroundColor:"#3BA55D"},dangerButton:{backgroundColor:"#ED4245"},warningButton:{backgroundColor:"#FAA61A"},infoButton:{backgroundColor:"#4F545C"},buttonText:{color:"white",fontWeight:"bold",fontSize:16},infoText:{color:"#B9BBBE",fontSize:14,marginHorizontal:16,marginVertical:8},warningText:{color:"#FAA61A",fontSize:13,marginHorizontal:16,marginVertical:4},successText:{color:"#3BA55D",fontSize:13,marginHorizontal:16,marginVertical:4},codeText:{fontFamily:"monospace",backgroundColor:"#2F3136",padding:8,borderRadius:4,marginHorizontal:16,marginVertical:4,color:"#DCDDDE"}});function H(){return window.__MESSAGE_FAKER__}function ve(){Ie.useProxy(n.storage);const[e,t]=a.React.useState(""),[r,s]=a.React.useState(""),[l,d]=a.React.useState(""),[h,_]=a.React.useState(""),[D,W]=a.React.useState(""),[v,P]=a.React.useState(""),[k,p]=a.React.useState(""),[x,y]=a.React.useState(""),[U,F]=a.React.useState(""),[O,Ce]=a.React.useState(""),[z,re]=a.React.useState(""),[ne,Te]=a.React.useState(""),[ie,oe]=a.React.useState(""),[Z,Re]=a.React.useState(""),[le,we]=a.React.useState(""),[J,ce]=a.React.useState(""),[q,Me]=a.React.useState(""),Ke=async function(){const c=H();if(!c){i.showToast("\u274C Plugin not ready","Small");return}if(!e.trim()){i.showToast("\u274C Enter target user ID","Small");return}if(!r.trim()){i.showToast("\u274C Enter sender user ID","Small");return}if(!l.trim()&&!v.trim()&&!D.trim()){i.showToast("\u274C Enter message content, embed URL, or manual embed","Small");return}let u;if(v||k||U||O||z||Z||x||J||q){if(u={},v&&(u.title=v),k&&(u.description=k),x){const M=x.trim();M.startsWith("#")?u.color=parseInt(M.substring(1),16):M.startsWith("0x")?u.color=parseInt(M,16):isNaN(Number(M))||(u.color=Number(M))}if(U&&(u.image={url:U}),O&&(u.thumbnail={url:O}),z&&(u.author={name:z},ne&&(u.author.url=ne),ie&&(u.author.icon_url=ie)),Z&&(u.footer={text:Z},le&&(u.footer.icon_url=le)),J&&(u.timestamp=J),q)try{const M=JSON.parse(q);Array.isArray(M)&&(u.fields=M)}catch{i.showToast("\u26A0\uFE0F Invalid fields JSON format","Small")}}try{await c.fakeMessage({targetUserId:e.trim(),fromUserId:r.trim(),content:l.trim(),embed:u,embedUrl:D.trim()||void 0,timestamp:h.trim()||void 0,persistent:!0})&&i.showToast("\u2705 Fake message sent!","Check")}catch{i.showToast("\u274C Failed to send message","Small")}},Ve=async function(){const c=H();if(!c){i.showToast("\u274C Plugin not ready","Small");return}if(!D.trim()){i.showToast("\u274C Enter a URL first","Small");return}try{i.showToast("\u{1F50D} Fetching embed data...","Small");const u=await c.fetchOpenGraphData(D.trim());u?(u.title&&P(u.title),u.description&&p(u.description),u.color&&y(u.color.toString()),u.image?.url&&F(u.image.url),u.author?.name&&re(u.author.name),u.author?.icon_url&&oe(u.author.icon_url),i.showToast("\u2705 Embed data loaded! Review and edit below","Check")):i.showToast("\u274C Could not fetch embed data from URL","Small")}catch{i.showToast("\u274C Failed to fetch embed data","Small")}},ze=async function(){const c=H();if(!c){i.showToast("\u274C Plugin not ready","Small");return}if(!e.trim()||!r.trim()){i.showToast("\u274C Fill in both User IDs first","Small");return}try{await c.quickTest(e.trim(),r.trim())}catch{i.showToast("\u274C Test failed","Small")}},Ze=async function(){try{const c=await a.clipboard.getString();c&&(t(c.trim()),i.showToast("\u{1F4CB} Pasted target user ID","clipboard"))}catch{i.showToast("Failed to paste","Small")}},Je=async function(){try{const c=await a.clipboard.getString();c&&(s(c.trim()),i.showToast("\u{1F4CB} Pasted sender user ID","clipboard"))}catch{i.showToast("Failed to paste","Small")}},qe=async function(){try{const c=await a.clipboard.getString();c&&(c.startsWith("http://")||c.startsWith("https://"))?(W(c.trim()),i.showToast("\u{1F4CB} Pasted URL","clipboard")):i.showToast("\u274C Clipboard doesn't contain a valid URL","Small")}catch{i.showToast("Failed to paste","Small")}},Ye=function(){_(new Date().toISOString()),i.showToast("\u23F0 Set to current time","Check")},Xe=function(){ce(new Date().toISOString()),i.showToast("\u23F0 Set embed to current time","Check")},Qe=a.React.useMemo(function(){return Object.values(n.storage.persistentMessages||{}).reduce(function(c,u){return c+(Array.isArray(u)?u.length:0)},0)},[n.storage.persistentMessages]),et=Object.keys(n.storage.persistentMessages||{}).length;return a.React.createElement(_e,null,a.React.createElement(T,{title:"MESSAGE FAKER v3.2.0"},a.React.createElement(m,{style:o.infoText},"\u{1F4AC} Inject fake messages into DMs with auto-embed from URLs!"),a.React.createElement(m,{style:o.successText},"\u2728 NEW: Paste any URL and get Discord embeds automatically!"),a.React.createElement($,{label:"Enable Plugin",subLabel:"Turn the plugin on/off",value:n.storage.enabled,onValueChange:function(c){n.storage.enabled=c,i.showToast(c?"\u2705 Enabled":"\u274C Disabled","Check")}}),a.React.createElement($,{label:"Auto-Inject on Startup",subLabel:"Automatically show fake messages when Discord starts",value:n.storage.autoInjectOnStartup,onValueChange:function(c){n.storage.autoInjectOnStartup=c}}),a.React.createElement($,{label:"Prevent Message Deletion",subLabel:"Fake messages can't be deleted (they reinject)",value:n.storage.preventMessageDeletion,onValueChange:function(c){n.storage.preventMessageDeletion=c}}),a.React.createElement($,{label:"Debug Mode",subLabel:"Enable detailed logging",value:n.storage.debug,onValueChange:function(c){n.storage.debug=c}})),a.React.createElement(A,null),a.React.createElement(T,{title:"CREATE FAKE MESSAGE"},a.React.createElement(m,{style:o.infoText},"\u{1F4DD} Create a fake message in someone's DM"),a.React.createElement(E,{title:"TARGET USER ID (Whose DM)",placeholder:"User ID of person whose DM you want to inject into",value:e,onChange:t}),a.React.createElement(R,{style:o.button,onPress:Ze},a.React.createElement(S,{style:o.buttonText},"\u{1F4CB} Paste Target User ID")),a.React.createElement(E,{title:"FROM USER ID (Who message is from)",placeholder:"User ID of who the message appears to be from",value:r,onChange:s}),a.React.createElement(R,{style:o.button,onPress:Je},a.React.createElement(S,{style:o.buttonText},"\u{1F4CB} Paste Sender User ID")),a.React.createElement(E,{title:"MESSAGE CONTENT",placeholder:"The message text (supports multiple lines)",value:l,onChange:d,multiline:!0,numberOfLines:4}),a.React.createElement(E,{title:"MESSAGE TIMESTAMP (Optional)",placeholder:"ISO 8601 format: 2024-01-15T12:30:00Z",value:h,onChange:_}),a.React.createElement(R,{style:o.button,onPress:Ye},a.React.createElement(S,{style:o.buttonText},"\u23F0 Set Current Time")),a.React.createElement(m,{style:o.warningText},"\u{1F4A1} Leave timestamp empty to use current time")),a.React.createElement(A,null),a.React.createElement(T,{title:"\u2728 AUTO-EMBED FROM URL (NEW!)"},a.React.createElement(m,{style:o.successText},"\u{1F517} Paste any URL and Discord will auto-generate an embed just like when you send a link!"),a.React.createElement(m,{style:o.infoText},"Works with: YouTube, Twitter, GitHub, news sites, and most websites with OpenGraph metadata."),a.React.createElement(E,{title:"EMBED URL",placeholder:"https://github.com/username/repo",value:D,onChange:W}),a.React.createElement(R,{style:o.button,onPress:qe},a.React.createElement(S,{style:o.buttonText},"\u{1F4CB} Paste URL from Clipboard")),a.React.createElement(R,{style:[o.button,o.infoButton],onPress:Ve},a.React.createElement(S,{style:o.buttonText},"\u{1F50D} Preview & Load Embed Data")),a.React.createElement(m,{style:o.warningText},"\u{1F4A1} The embed will be fetched automatically when you send the message, OR you can preview it first to edit manually below")),a.React.createElement(A,null),a.React.createElement(T,{title:"MANUAL EMBED (Optional)"},a.React.createElement(m,{style:o.infoText},"\u{1F4CE} Manually customize your embed (or edit auto-fetched data)"),a.React.createElement(E,{title:"EMBED TITLE",placeholder:"Title (max 256 characters)",value:v,onChange:P}),a.React.createElement(E,{title:"EMBED DESCRIPTION",placeholder:"Description (max 4096 characters)",value:k,onChange:p,multiline:!0,numberOfLines:4}),a.React.createElement(E,{title:"EMBED COLOR",placeholder:"Hex (#5865F2) or Decimal (5793266)",value:x,onChange:y}),a.React.createElement(E,{title:"IMAGE URL",placeholder:"Large image at bottom",value:U,onChange:F}),a.React.createElement(E,{title:"THUMBNAIL URL",placeholder:"Small image at top-right",value:O,onChange:Ce}),a.React.createElement(m,{style:o.infoText},"\u{1F464} Embed Author Section"),a.React.createElement(E,{title:"AUTHOR NAME",placeholder:"Name (max 256 characters)",value:z,onChange:re}),a.React.createElement(E,{title:"AUTHOR URL",placeholder:"URL when author name is clicked",value:ne,onChange:Te}),a.React.createElement(E,{title:"AUTHOR ICON URL",placeholder:"Small icon next to author name",value:ie,onChange:oe}),a.React.createElement(m,{style:o.infoText},"\u{1F9B6} Embed Footer Section"),a.React.createElement(E,{title:"FOOTER TEXT",placeholder:"Footer text (max 2048 characters)",value:Z,onChange:Re}),a.React.createElement(E,{title:"FOOTER ICON URL",placeholder:"Small icon next to footer text",value:le,onChange:we}),a.React.createElement(E,{title:"EMBED TIMESTAMP",placeholder:"ISO 8601: 2024-01-15T12:30:00Z",value:J,onChange:ce}),a.React.createElement(R,{style:o.button,onPress:Xe},a.React.createElement(S,{style:o.buttonText},"\u23F0 Set Current Time")),a.React.createElement(m,{style:o.infoText},"\u{1F4CA} Embed Fields (Advanced)"),a.React.createElement(E,{title:"FIELDS (JSON Array)",placeholder:'[{"name":"Field 1","value":"Value 1","inline":true}]',value:q,onChange:Me}),a.React.createElement(m,{style:o.warningText},"\u{1F4A1} Max 25 fields. Field name: max 256 chars, value: max 1024 chars")),a.React.createElement(A,null),a.React.createElement(T,{title:"SEND MESSAGE"},a.React.createElement(R,{style:[o.button,o.successButton],onPress:Ke},a.React.createElement(S,{style:o.buttonText},"\u2709\uFE0F Send Fake Message")),a.React.createElement(R,{style:[o.button,o.warningButton],onPress:ze},a.React.createElement(S,{style:o.buttonText},"\u{1F9EA} Quick Test Message"))),a.React.createElement(A,null),a.React.createElement(T,{title:"CONSOLE API EXAMPLES"},a.React.createElement(m,{style:o.infoText},"\u{1F527} Advanced usage via console:"),a.React.createElement(m,{style:o.successText},"\u2728 NEW: Auto-embed from URL"),a.React.createElement(S,{style:o.codeText},`// Auto-generate embed from URL
__MESSAGE_FAKER__.fakeMessage({
  targetUserId: "USER_ID",
  fromUserId: "USER_ID",
  content: "Check this out!",
  embedUrl: "https://github.com/user/repo",
  persistent: true
});`),a.React.createElement(S,{style:o.codeText},`// Test URL embed fetching
const embed = await __MESSAGE_FAKER__
  .fetchOpenGraphData("https://example.com");
console.log(embed);`),a.React.createElement(S,{style:o.codeText},`// Full manual embed example
__MESSAGE_FAKER__.fakeMessage({
  targetUserId: "USER_ID",
  fromUserId: "USER_ID",
  content: "Check this embed!",
  embed: {
    title: "Amazing Embed",
    description: "Full description",
    url: "https://example.com",
    color: 0x5865F2,
    timestamp: "2024-01-15T12:30:00Z",
    author: {
      name: "Author Name",
      url: "https://example.com",
      icon_url: "https://i.imgur.com/..."
    },
    image: {
      url: "https://i.imgur.com/..."
    },
    fields: [
      {
        name: "Field 1",
        value: "Value 1",
        inline: true
      }
    ]
  },
  persistent: true
});`),a.React.createElement(m,{style:o.infoText},"Open debug console to use these commands")),a.React.createElement(A,null),a.React.createElement(T,{title:"EMBED COLOR REFERENCE"},a.React.createElement(m,{style:o.infoText},"\u{1F3A8} Common Discord colors:"),a.React.createElement(S,{style:o.codeText},`Blurple: #5865F2 (5793266)
Green: #57F287 (5763719)
Yellow: #FEE75C (16705372)
Fuchsia: #EB459E (15418782)
Red: #ED4245 (15548997)
White: #FFFFFF (16777215)
Black: #000000 (0)`)),a.React.createElement(A,null),a.React.createElement(T,{title:"STATISTICS"},a.React.createElement(m,{style:o.infoText},"\u{1F4CA} Current fake messages: ",Qe," messages in ",et," channels")),a.React.createElement(A,null),a.React.createElement(T,{title:"DANGER ZONE"},a.React.createElement(R,{style:[o.button,o.dangerButton],onPress:function(){const c=H();c&&c.clearAllMessages(),t(""),s(""),d(""),_(""),W(""),P(""),p(""),y(""),F(""),Ce(""),re(""),Te(""),oe(""),Re(""),we(""),ce(""),Me("")}},a.React.createElement(S,{style:o.buttonText},"\u{1F5D1}\uFE0F Clear ALL Fake Messages")),a.React.createElement(m,{style:o.warningText},"\u26A0\uFE0F This will remove all fake messages from storage. They will disappear on next reload.")),a.React.createElement(m,{style:[o.infoText,{marginTop:16,marginBottom:32,textAlign:"center"}]},"MessageFaker v3.2.0 - Auto-Embed Edition",`
`,"\u2728 Auto-Embed from URLs \u2022 Timestamp Control \u2022 Full Embed Support"))}n.storage.enabled??=!0,n.storage.debug??=!1,n.storage.persistentMessages??={},n.storage.autoInjectOnStartup??=!0,n.storage.preventMessageDeletion??=!0,n.storage.testedParameters??={};const Y=[];let B=null,K=null,ke=null,j=null,X=null,xe=null,Q=null,V=null;const b={basicMessageCreate:{tested:!1,works:!1,notificationCount:0},messageCreateWithLocal:{tested:!1,works:!1,notificationCount:0},messageCreateWithSilent:{tested:!1,works:!1,notificationCount:0},messageCreateWithCached:{tested:!1,works:!1,notificationCount:0},loadMessagesSuccess:{tested:!1,works:!1,notificationCount:0},loadMessagesSuccessWithCached:{tested:!1,works:!1,notificationCount:0},channelAckBasic:{tested:!1,works:!1},channelAckWithManual:{tested:!1,works:!1},channelAckWithLocal:{tested:!1,works:!1},channelAckWithBoth:{tested:!1,works:!1}},g=function(e,t){n.storage.debug&&I.logger.log(`[MessageInjector] ${e}`,t||"")},f=function(e,t){I.logger.error(`[MessageInjector] ${e}`,t||"")},G=function(e){return new Promise(function(t){return setTimeout(t,e)})};function de(e){if(!e)return new Date().toISOString();try{const t=new Date(e);return isNaN(t.getTime())?(f("Invalid timestamp, using current time",e),new Date().toISOString()):t.toISOString()}catch(t){return f("Failed to parse timestamp, using current time",t),new Date().toISOString()}}function ee(e){return!e||typeof e!="string"?!1:/^\d+$/.test(e.trim())}function Ue(e){if(typeof e=="number")return e;if(typeof e=="string"){const t=e.trim();if(t.startsWith("#")){const r=parseInt(t.substring(1),16);return isNaN(r)?void 0:r}else if(t.startsWith("0x")){const r=parseInt(t,16);return isNaN(r)?void 0:r}else if(!isNaN(Number(t)))return Number(t)}}async function he(e){try{g(`Fetching OpenGraph data from: ${e}`);const t=await fetch(e,{headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"}});if(!t.ok)throw new Error(`HTTP ${t.status}`);const r=await t.text(),s={},l={},d=/<meta\s+property=["']og:([^"']+)["']\s+content=["']([^"']+)["']/gi;let h;for(;(h=d.exec(r))!==null;)s[h[1]]=h[2];const _=/<meta\s+(?:name|property)=["']twitter:([^"']+)["']\s+content=["']([^"']+)["']/gi;for(;(h=_.exec(r))!==null;)l[h[1]]=h[2];const D=/<meta\s+content=["']([^"']+)["']\s+property=["']og:([^"']+)["']/gi;for(;(h=D.exec(r))!==null;)s[h[2]]=h[1];const W=/<meta\s+content=["']([^"']+)["']\s+(?:name|property)=["']twitter:([^"']+)["']/gi;for(;(h=W.exec(r))!==null;)l[h[2]]=h[1];const v=/<meta\s+name=["']theme-color["']\s+content=["']([^"']+)["']/i,P=r.match(v),k=P?P[1]:null;g("Parsed OpenGraph data:",s),g("Parsed Twitter data:",l);const p={type:s.type||"rich"};if((s.title||l.title)&&(p.title=s.title||l.title),(s.description||l.description)&&(p.description=s.description||l.description),(s.url||e)&&(p.url=s.url||e),k){const y=Ue(k);y!==void 0&&(p.color=y)}const x=s.image||l.image||l["image:src"];if(x&&(p.image={url:x},s["image:width"]&&s["image:height"]&&(p.image.width=parseInt(s["image:width"]),p.image.height=parseInt(s["image:height"]))),s.site_name){p.author={name:s.site_name};const y=/<link\s+rel=["'](?:icon|shortcut icon)["']\s+(?:type=["'][^"']+["']\s+)?href=["']([^"']+)["']/i,U=r.match(y);if(U){let F=U[1];if(F.startsWith("/")){const O=new URL(e);F=`${O.protocol}//${O.host}${F}`}p.author.icon_url=F}}if(p.url)try{const y=new URL(p.url);p.provider={name:y.hostname,url:`${y.protocol}//${y.host}`}}catch{}return p.title||p.description||p.image?(g("Successfully created embed from URL:",p),p):(g("No meaningful OpenGraph data found"),null)}catch(t){return f("Failed to fetch OpenGraph data",t),null}}function Oe(e){if(e)try{const t={type:"rich"};if(e.title&&typeof e.title=="string"&&(t.title=e.title.substring(0,256)),e.description&&typeof e.description=="string"&&(t.description=e.description.substring(0,4096)),e.url&&typeof e.url=="string"&&(t.url=e.url),e.timestamp&&typeof e.timestamp=="string"&&(t.timestamp=de(e.timestamp)),typeof e.color=="number"&&(t.color=e.color),e.footer&&typeof e.footer=="object"&&(t.footer={},e.footer.text&&typeof e.footer.text=="string"&&(t.footer.text=e.footer.text.substring(0,2048)),e.footer.icon_url&&typeof e.footer.icon_url=="string"&&(t.footer.icon_url=e.footer.icon_url)),e.image?.url&&typeof e.image.url=="string"&&(t.image={url:e.image.url},typeof e.image.width=="number"&&(t.image.width=e.image.width),typeof e.image.height=="number"&&(t.image.height=e.image.height)),e.thumbnail?.url&&typeof e.thumbnail.url=="string"&&(t.thumbnail={url:e.thumbnail.url}),e.author&&typeof e.author=="object"&&(t.author={},e.author.name&&typeof e.author.name=="string"&&(t.author.name=e.author.name.substring(0,256)),e.author.url&&typeof e.author.url=="string"&&(t.author.url=e.author.url),e.author.icon_url&&typeof e.author.icon_url=="string"&&(t.author.icon_url=e.author.icon_url)),e.provider&&typeof e.provider=="object"&&(t.provider={},e.provider.name&&typeof e.provider.name=="string"&&(t.provider.name=e.provider.name),e.provider.url&&typeof e.provider.url=="string"&&(t.provider.url=e.provider.url)),e.fields&&Array.isArray(e.fields)){const r=e.fields.slice(0,25).map(function(s){return!s||typeof s!="object"||!s.name||!s.value?null:{name:String(s.name).substring(0,256),value:String(s.value).substring(0,1024),inline:Boolean(s.inline)}}).filter(Boolean);r.length>0&&(t.fields=r)}return Object.keys(t).length>1?t:void 0}catch(t){f("Failed to validate embed",t);return}}function L(e,t=[]){for(const r of e)try{const s=ue.findByStoreName(r);if(s&&(t.length===0||t.every(function(l){return typeof s[l]=="function"})))return g(`Found store: ${r}`),s}catch{}if(t.length>0)try{const r=ue.findByProps(...t);if(r)return g(`Found store by props: ${t.join(", ")}`),r}catch{}return null}async function Le(e){try{if(K){const t=K.getUser?.(e);if(t){const r={username:t.username||"Unknown User",discriminator:t.discriminator||"0",global_name:t.globalName||t.global_name||void 0,avatar:t.avatar?`https://cdn.discordapp.com/avatars/${e}/${t.avatar}.${t.avatar.startsWith("a_")?"gif":"png"}`:null,public_flags:t.publicFlags||t.public_flags||0};if(t.avatarDecorationData||t.avatar_decoration_data){const l=t.avatarDecorationData||t.avatar_decoration_data;r.avatar_decoration_data={asset:l.asset,sku_id:l.skuId||l.sku_id}}else if(t.avatarDecoration||t.avatar_decoration){const l=t.avatarDecoration||t.avatar_decoration;r.avatar_decoration_data={asset:l,sku_id:void 0}}const s=t.clan||t.primaryGuild||t.primary_guild;return s&&(r.clan={identity_guild_id:s.identityGuildId||s.identity_guild_id||null,identity_enabled:s.identityEnabled??s.identity_enabled??!1,tag:s.tag||null,badge:s.badge||null}),r}}}catch(t){f("Failed to get user info",t)}return{username:"Unknown User",discriminator:"0",avatar:null,public_flags:0}}function ge(e){try{if(B?.getDMFromUserId){const t=B.getDMFromUserId(e);return g(`DM channel for user ${e}: ${t}`),t}}catch(t){f("Failed to get DM channel",t)}return null}async function fe(e){try{let t=ge(e);if(!t&&X)try{const r=X.getPrivateChannelIds?.();if(r)for(const s of r){const l=B?.getChannel?.(s);if(l?.type===1&&l.recipients?.includes(e)){t=s;break}}t||(a.FluxDispatcher.dispatch({type:"CHANNEL_SELECT",channelId:null,guildId:null}),await G(100),t=ge(e))}catch(r){f("Failed to ensure DM channel",r)}return t}catch(t){return f("Failed to ensure DM channel",t),null}}function pe(){const e=Date.now(),t=Math.floor(Math.random()*4096);return`${e}${t.toString().padStart(4,"0")}`}async function me(e){if(!ee(e.userId))throw new Error("Invalid user ID");const t=await Le(e.userId);let r=e.username||t.username,s=e.avatar||t.avatar;const l=de(e.timestamp),d=Oe(e.embed),h={id:e.messageId||pe(),channel_id:e.channelId,author:{id:e.userId,username:r||"Unknown User",global_name:t.global_name,discriminator:t.discriminator||"0",avatar:s?s.split("/").pop()?.split(".")[0]:null,avatar_decoration_data:t.avatar_decoration_data,clan:t.clan,public_flags:t.public_flags||0,bot:!1},content:(e.content||"").substring(0,2e3),timestamp:l,edited_timestamp:null,tts:!1,mention_everyone:!1,mentions:[],mention_roles:[],attachments:[],embeds:d?[d]:[],reactions:[],pinned:!1,type:0,flags:0};return g("Created message object",h),h}async function Ne(e,t){if(!a.FluxDispatcher)return!1;try{switch(t){case"basicMessageCreate":a.FluxDispatcher.dispatch({type:"MESSAGE_CREATE",channelId:e.channel_id,message:e,optimistic:!1});break;case"messageCreateWithLocal":a.FluxDispatcher.dispatch({type:"MESSAGE_CREATE",channelId:e.channel_id,message:e,optimistic:!1,local:!0});break;case"messageCreateWithSilent":a.FluxDispatcher.dispatch({type:"MESSAGE_CREATE",channelId:e.channel_id,message:e,optimistic:!1,silent:!0});break;case"messageCreateWithCached":a.FluxDispatcher.dispatch({type:"MESSAGE_CREATE",channelId:e.channel_id,message:e,optimistic:!1,cached:!0});break;case"loadMessagesSuccess":a.FluxDispatcher.dispatch({type:"LOAD_MESSAGES_SUCCESS",channelId:e.channel_id,messages:[e],isBefore:!1,isAfter:!1});break;case"loadMessagesSuccessWithCached":a.FluxDispatcher.dispatch({type:"LOAD_MESSAGES_SUCCESS",channelId:e.channel_id,messages:[e],isBefore:!1,isAfter:!1,cached:!0});break;default:return!1}return g(`Tested injection method: ${t}`),!0}catch(r){return f(`Failed to test ${t}`,r),!1}}async function Pe(e,t,r){if(!a.FluxDispatcher)return!1;try{switch(r){case"channelAckBasic":a.FluxDispatcher.dispatch({type:"CHANNEL_ACK",channelId:e,messageId:t});break;case"channelAckWithManual":a.FluxDispatcher.dispatch({type:"CHANNEL_ACK",channelId:e,messageId:t,manual:!0});break;case"channelAckWithLocal":a.FluxDispatcher.dispatch({type:"CHANNEL_ACK",channelId:e,messageId:t,local:!0});break;case"channelAckWithBoth":a.FluxDispatcher.dispatch({type:"CHANNEL_ACK",channelId:e,messageId:t,manual:!0,local:!0});break;default:return!1}return g(`Tested ACK method: ${r}`),!0}catch(s){return f(`Failed to test ${r}`,s),!1}}function te(e){if(!a.FluxDispatcher)return f("FluxDispatcher not available"),!1;try{const t=Be();return t==="loadMessagesSuccess"?a.FluxDispatcher.dispatch({type:"LOAD_MESSAGES_SUCCESS",channelId:e.channel_id,messages:[e],isBefore:!1,isAfter:!1}):t==="loadMessagesSuccessWithCached"?a.FluxDispatcher.dispatch({type:"LOAD_MESSAGES_SUCCESS",channelId:e.channel_id,messages:[e],isBefore:!1,isAfter:!1,cached:!0}):a.FluxDispatcher.dispatch({type:"MESSAGE_CREATE",channelId:e.channel_id,message:e,optimistic:!1}),g("Message injected successfully",e.id),!0}catch(t){return f("Failed to inject message",t),!1}}function Be(){const e=Object.entries(b).filter(function([t,r]){return r.tested&&r.works&&t.includes("message")||t.includes("load")}).sort(function(t,r){const s=t[1].notificationCount||0,l=r[1].notificationCount||0;return s-l});return e.length>0?e[0][0]:"basicMessageCreate"}function N(){try{typeof n.storage.persistentMessages!="object"&&(n.storage.persistentMessages={}),Object.keys(n.storage.persistentMessages).forEach(function(e){Array.isArray(n.storage.persistentMessages[e])||delete n.storage.persistentMessages[e]}),n.storage.persistentMessages=JSON.parse(JSON.stringify(n.storage.persistentMessages)),n.storage.testedParameters=b,g("Saved persistent messages and test results")}catch(e){f("Failed to save persistent messages",e),n.storage.persistentMessages={}}}async function ae(e){try{if(!ee(e.fromUserId))return f("Invalid sender user ID"),i.showToast&&i.showToast("\u274C Invalid sender user ID","Small"),!1;let t=e.channelId;if(!t&&e.targetUserId){if(!ee(e.targetUserId))return f("Invalid target user ID"),i.showToast&&i.showToast("\u274C Invalid target user ID","Small"),!1;t=await fe(e.targetUserId)}if(!t)return f("No valid channel ID found"),i.showToast&&i.showToast("\u274C Could not find DM channel","Small"),!1;let r=e.embed;if(e.embedUrl&&!r){i.showToast&&i.showToast("\u{1F50D} Fetching embed data...","Small");const d=await he(e.embedUrl);d?(r=d,i.showToast&&i.showToast("\u2705 Embed data fetched!","Check")):i.showToast&&i.showToast("\u26A0\uFE0F Could not fetch embed data","Small")}const s=await me({channelId:t,userId:e.fromUserId,content:e.content,username:e.username,avatar:e.avatar,embed:r,timestamp:e.timestamp});e.persistent&&(n.storage.persistentMessages[t]||(n.storage.persistentMessages[t]=[]),new Set(n.storage.persistentMessages[t].map(function(d){return d.id})).has(s.id)||n.storage.persistentMessages[t].push(s),N(),g("Message saved to persistent storage",s.id));const l=te(s);return l&&g("Fake message sent successfully"),l}catch(t){return f("Failed to send fake message",t),i.showToast&&i.showToast("\u274C Failed to send message","Small"),!1}}function w(e){if(!n.storage.persistentMessages[e])return;const t=n.storage.persistentMessages[e];if(!Array.isArray(t)){delete n.storage.persistentMessages[e],N();return}g(`Reinjecting ${t.length} messages for channel ${e}`),t.forEach(function(r,s){setTimeout(function(){try{te(r)}catch(l){f("Failed to reinject message",l)}},s*50)})}function je(){try{if(!a.FluxDispatcher)return;const e=Ae.before("dispatch",a.FluxDispatcher,function(t){if(!n.storage.enabled)return;const r=t[0];if(!(!r||!r.type)){if(n.storage.preventMessageDeletion&&r.type==="MESSAGE_DELETE"){const s=r.id,l=r.channelId;if(l&&n.storage.persistentMessages[l]){const d=n.storage.persistentMessages[l].find(function(h){return h.id===s});d&&(g("Prevented deletion of fake message",s),t[0]={type:"NOOP"},setTimeout(function(){return te(d)},100))}}if(n.storage.preventMessageDeletion&&r.type==="MESSAGE_DELETE_BULK"){const s=r.channelId;if(s&&n.storage.persistentMessages[s]){const l=r.ids||[];n.storage.persistentMessages[s].some(function(d){return l.includes(d.id)})&&(t[0]={type:"NOOP"},setTimeout(function(){return w(s)},200))}}if(r.type==="CHANNEL_SELECT"){const s=r.channelId;s&&n.storage.persistentMessages[s]&&setTimeout(function(){return w(s)},300)}if(r.type==="LOAD_MESSAGES_SUCCESS"||r.type==="LOAD_MESSAGES"||r.type==="LOCAL_MESSAGES_LOADED"){const s=r.channelId;s&&n.storage.persistentMessages[s]&&setTimeout(function(){return w(s)},500)}if(r.type==="MESSAGE_UPDATE"){const s=r.message?.channel_id,l=r.message?.id;if(s&&l&&n.storage.persistentMessages[s]){const d=n.storage.persistentMessages[s];Array.isArray(d)&&(d.some(function(h){return h&&h.id===l})||setTimeout(function(){return w(s)},100))}}if((r.type==="CHANNEL_UPDATES"||r.type==="CACHE_LOADED"||r.type==="OVERLAY_INITIALIZE"||r.type==="CONNECTION_OPEN")&&j){const s=j.getChannelId?.();s&&n.storage.persistentMessages[s]&&setTimeout(function(){return w(s)},600)}}});Y.push(e),g("Message persistence system setup")}catch(e){f("Failed to setup message persistence",e)}}function Ge(){V=setInterval(function(){if(j)try{const e=j.getChannelId?.();if(e&&e!==Q){const t=Q;Q=e,g(`Channel switched from ${t} to ${e}`),n.storage.persistentMessages[e]&&setTimeout(function(){w(e)},300)}}catch{}},1e3)}function Ee(){n.storage.persistentMessages={},N(),g("Cleared all persistent messages"),i.showToast&&i.showToast("\u2705 All fake messages cleared","Check")}function Se(e){n.storage.persistentMessages[e]&&(delete n.storage.persistentMessages[e],N(),g(`Cleared messages for channel ${e}`),i.showToast&&i.showToast("\u2705 Channel messages cleared","Check"))}function ye(){return n.storage.persistentMessages}async function be(e,t){return await ae({targetUserId:e,fromUserId:t,content:"Test message from Message Injector plugin! \u{1F389}",persistent:!0})}async function se(e,t){g("Starting parameter tests...");const r=await fe(e);if(!r){f("Cannot run tests: No DM channel"),i.showToast&&i.showToast("\u274C Cannot run tests: No DM channel","Small");return}const s=await me({channelId:r,userId:t,content:"\u{1F9EA} Testing injection parameters...",username:"Test Bot"});for(const d of["basicMessageCreate","messageCreateWithLocal","messageCreateWithSilent","messageCreateWithCached","loadMessagesSuccess","loadMessagesSuccessWithCached"]){const h={...s,id:pe(),content:`\u{1F9EA} Test: ${d}`},_=await Ne(h,d);b[d].tested=!0,b[d].works=_,await G(1e3)}const l=s.id;for(const d of["channelAckBasic","channelAckWithManual","channelAckWithLocal","channelAckWithBoth"]){const h=await Pe(r,l,d);b[d].tested=!0,b[d].works=h,await G(500)}N(),g("Parameter tests complete",b),i.showToast&&i.showToast("\u2705 Tests complete! Check console for results","Check")}async function We(){try{B=L(["ChannelStore"],["getChannel","getDMFromUserId"]),K=L(["UserStore","CurrentUserStore"],["getUser","getCurrentUser"]),ke=L(["MessageStore"],["getMessages","getMessage"]),j=L(["SelectedChannelStore"],["getChannelId"]),X=L(["PrivateChannelStore"],["getPrivateChannelIds"]),xe=L(["RelationshipStore"],["getRelationships"]);const e=B&&K;return e?g("All critical modules loaded"):f("Some modules failed to load"),e}catch(e){return f("Failed to initialize modules",e),!1}}function $e(){try{if(typeof n.storage.persistentMessages!="object"||n.storage.persistentMessages===null){I.logger.warn("[MessageInjector] Corrupted storage detected, resetting..."),n.storage.persistentMessages={};return}Object.keys(n.storage.persistentMessages).forEach(function(e){Array.isArray(n.storage.persistentMessages[e])?(n.storage.persistentMessages[e]=n.storage.persistentMessages[e].filter(function(t){return t&&t.id&&t.channel_id&&t.author&&t.timestamp}),n.storage.persistentMessages[e].length===0&&delete n.storage.persistentMessages[e]):delete n.storage.persistentMessages[e]}),N()}catch(e){f("Failed to recover storage",e),n.storage.persistentMessages={}}}var He={onLoad:async function(){try{if(I.logger.log("[MessageInjector] Loading v3.2.0 (Auto-Embed Edition)..."),$e(),n.storage.testedParameters&&(Object.assign(b,n.storage.testedParameters),g("Loaded previous test results",b)),await G(1e3),!await We()){f("Failed to load critical modules"),i.showToast&&i.showToast("\u274C Plugin failed to load","Small");return}if(je(),Ge(),n.storage.autoInjectOnStartup){await G(2e3);const e=Object.keys(n.storage.persistentMessages).length;e>0&&(g(`Auto-injecting messages for ${e} channels on startup`),Object.keys(n.storage.persistentMessages).forEach(function(t){setTimeout(function(){w(t)},500)}))}window.__MESSAGE_FAKER__={fakeMessage:ae,fetchOpenGraphData:he,clearAllMessages:Ee,clearChannelMessages:Se,getAllMessages:ye,quickTest:be,runParameterTests:se,reinjectChannel:function(e){return w(e)},reinjectAll:function(){Object.keys(n.storage.persistentMessages).forEach(function(e){w(e)})},getStatus:function(){return{enabled:n.storage.enabled,messageCount:Object.values(n.storage.persistentMessages).reduce(function(e,t){return e+t.length},0),channelCount:Object.keys(n.storage.persistentMessages).length,testResults:b}},getTestResults:function(){return b},testInjection:async function(e,t){await se(e,t)}},I.logger.log("[MessageInjector] \u2705 Loaded successfully v3.2.0"),I.logger.log("[MessageInjector] New: Auto-embed generation from URLs!")}catch(e){f("Fatal error during load",e),i.showToast&&i.showToast("\u274C Plugin failed to load","Small")}},onUnload:function(){try{for(const e of Y)try{e()}catch{}Y.length=0,V&&(clearInterval(V),V=null),window.__MESSAGE_FAKER__&&delete window.__MESSAGE_FAKER__,I.logger.log("[MessageInjector] Unloaded"),i.showToast&&i.showToast("Plugin unloaded","Check")}catch(e){f("Error during unload",e)}},settings:ve};return C.clearAllMessages=Ee,C.clearChannelMessages=Se,C.default=He,C.fakeMessage=ae,C.getAllMessages=ye,C.quickTest=be,C.runParameterTests=se,Object.defineProperty(C,"__esModule",{value:!0}),C})({},vendetta.metro.common,vendetta.metro,vendetta.patcher,vendetta.plugin,vendetta.ui.toasts,vendetta,vendetta.ui.components,vendetta.storage);
