(function(m,a,N,q,s,n,S,J,Z){"use strict";const{FormInput:T,FormSwitch:R,FormSection:I,FormDivider:C,FormRow:Se,FormText:M}=J.Forms,{View:Te,Text:y,ScrollView:Q,TouchableOpacity:b,StyleSheet:X}=a.ReactNative,l=X.create({button:{backgroundColor:"#5865F2",padding:12,borderRadius:8,alignItems:"center",marginVertical:8,marginHorizontal:16},successButton:{backgroundColor:"#3BA55D"},dangerButton:{backgroundColor:"#ED4245"},warningButton:{backgroundColor:"#FAA61A"},buttonText:{color:"white",fontWeight:"bold",fontSize:16},infoText:{color:"#B9BBBE",fontSize:14,marginHorizontal:16,marginVertical:8},warningText:{color:"#FAA61A",fontSize:13,marginHorizontal:16,marginVertical:4},codeText:{fontFamily:"monospace",backgroundColor:"#2F3136",padding:8,borderRadius:4,marginHorizontal:16,marginVertical:4,color:"#DCDDDE"}});function U(){return window.__MESSAGE_FAKER__}function ee(){Z.useProxy(s.storage);const[e,t]=a.React.useState(""),[r,o]=a.React.useState(""),[u,h]=a.React.useState(""),[E,z]=a.React.useState(""),[B,Y]=a.React.useState(""),[p,W]=a.React.useState(""),fe=async function(){const i=U();if(!i){n.showToast("\u274C Plugin not ready","Small");return}if(!e.trim()){n.showToast("\u274C Enter target user ID","Small");return}if(!r.trim()){n.showToast("\u274C Enter sender user ID","Small");return}if(!u.trim()&&!E.trim()){n.showToast("\u274C Enter message content or embed","Small");return}const O=E||B||p?{title:E||void 0,description:B||void 0,image:p?{url:p}:void 0,thumbnail:p?{url:p}:void 0,type:"rich"}:void 0;try{await i.fakeMessage({targetUserId:e.trim(),fromUserId:r.trim(),content:u.trim(),embed:O,persistent:!0})&&n.showToast("\u2705 Fake message sent!","Check")}catch{n.showToast("\u274C Failed to send message","Small")}},he=async function(){const i=U();if(!i){n.showToast("\u274C Plugin not ready","Small");return}if(!e.trim()||!r.trim()){n.showToast("\u274C Fill in both User IDs first","Small");return}try{await i.quickTest(e.trim(),r.trim())}catch{n.showToast("\u274C Test failed","Small")}},Ee=async function(){try{const i=await a.clipboard.getString();i&&(t(i.trim()),n.showToast("\u{1F4CB} Pasted target user ID","clipboard"))}catch{n.showToast("Failed to paste","Small")}},me=async function(){try{const i=await a.clipboard.getString();i&&(o(i.trim()),n.showToast("\u{1F4CB} Pasted sender user ID","clipboard"))}catch{n.showToast("Failed to paste","Small")}},Me=a.React.useMemo(function(){return Object.values(s.storage.persistentMessages||{}).reduce(function(i,O){return i+(Array.isArray(O)?O.length:0)},0)},[s.storage.persistentMessages]),ye=Object.keys(s.storage.persistentMessages||{}).length;return a.React.createElement(Q,null,a.React.createElement(I,{title:"MESSAGE FAKER"},a.React.createElement(M,{style:l.infoText},"\u{1F4AC} Inject fake messages into DMs from anyone."),a.React.createElement(R,{label:"Enable Plugin",subLabel:"Turn the plugin on/off",value:s.storage.enabled,onValueChange:function(i){s.storage.enabled=i,n.showToast(i?"\u2705 Enabled":"\u274C Disabled","Check")}}),a.React.createElement(R,{label:"Auto-Inject on Startup",subLabel:"Automatically show fake messages when Discord starts",value:s.storage.autoInjectOnStartup,onValueChange:function(i){s.storage.autoInjectOnStartup=i}}),a.React.createElement(R,{label:"Prevent Message Deletion",subLabel:"Fake messages can't be deleted (they reinject)",value:s.storage.preventMessageDeletion,onValueChange:function(i){s.storage.preventMessageDeletion=i}}),a.React.createElement(R,{label:"Debug Mode",subLabel:"Enable detailed logging",value:s.storage.debug,onValueChange:function(i){s.storage.debug=i}})),a.React.createElement(C,null),a.React.createElement(I,{title:"CREATE FAKE MESSAGE"},a.React.createElement(M,{style:l.infoText},"\u{1F4DD} Create a fake message in someone's DM"),a.React.createElement(T,{title:"TARGET USER ID (Whose DM)",placeholder:"User ID of person whose DM you want to inject into",value:e,onChange:t}),a.React.createElement(b,{style:l.button,onPress:Ee},a.React.createElement(y,{style:l.buttonText},"\u{1F4CB} Paste Target User ID")),a.React.createElement(T,{title:"FROM USER ID (Who message is from)",placeholder:"User ID of who the message appears to be from",value:r,onChange:o}),a.React.createElement(b,{style:l.button,onPress:me},a.React.createElement(y,{style:l.buttonText},"\u{1F4CB} Paste Sender User ID")),a.React.createElement(T,{title:"MESSAGE CONTENT",placeholder:"The message text",value:u,onChange:h}),a.React.createElement(M,{style:l.infoText},"\u{1F4CE} Optional: Add an embed"),a.React.createElement(T,{title:"EMBED TITLE",placeholder:"Optional embed title",value:E,onChange:z}),a.React.createElement(T,{title:"EMBED DESCRIPTION",placeholder:"Optional embed description",value:B,onChange:Y}),a.React.createElement(T,{title:"EMBED IMAGE URL",placeholder:"Optional image URL",value:p,onChange:W}),a.React.createElement(b,{style:[l.button,l.successButton],onPress:fe},a.React.createElement(y,{style:l.buttonText},"\u2709\uFE0F Send Fake Message")),a.React.createElement(b,{style:[l.button,l.warningButton],onPress:he},a.React.createElement(y,{style:l.buttonText},"\u{1F9EA} Quick Test Message"))),a.React.createElement(C,null),a.React.createElement(I,{title:"CONSOLE API"},a.React.createElement(M,{style:l.infoText},"\u{1F527} You can also use the console for advanced usage:"),a.React.createElement(y,{style:l.codeText},`// Send fake message
__MESSAGE_FAKER__.fakeMessage({
  targetUserId: "USER_ID",
  fromUserId: "USER_ID",
  content: "Hello!",
  persistent: true
});`),a.React.createElement(y,{style:l.codeText},`// With embed
__MESSAGE_FAKER__.fakeMessage({
  targetUserId: "USER_ID",
  fromUserId: "USER_ID",
  content: "Check this out!",
  embed: {
    title: "Cool Title",
    description: "Description",
    image: { url: "https://..." }
  }
});`),a.React.createElement(M,{style:l.infoText},"Open Kettu debug console to use these commands")),a.React.createElement(C,null),a.React.createElement(I,{title:"STATISTICS"},a.React.createElement(M,{style:l.infoText},"\u{1F4CA} Current fake messages: ",Me," messages in ",ye," channels")),a.React.createElement(C,null),a.React.createElement(I,{title:"DANGER ZONE"},a.React.createElement(b,{style:[l.button,l.dangerButton],onPress:function(){const i=U();i&&i.clearAllMessages(),t(""),o(""),h(""),z(""),Y(""),W("")}},a.React.createElement(y,{style:l.buttonText},"\u{1F5D1}\uFE0F Clear ALL Fake Messages")),a.React.createElement(M,{style:l.warningText},"\u26A0\uFE0F This will remove all fake messages from storage. They will disappear on next reload.")),a.React.createElement(M,{style:[l.infoText,{marginTop:16,marginBottom:32,textAlign:"center"}]},"MessageFaker v1.0.0 for Kettu/Bunny/Vendetta"))}s.storage.enabled??=!0,s.storage.debug??=!1,s.storage.persistentMessages??={},s.storage.autoInjectOnStartup??=!0,s.storage.preventMessageDeletion??=!0;const k=[];let A=null,D=null,te=null,P=null,g=null,F=null,v=null;const d=function(e,t){s.storage.debug&&S.logger.log(`[MessageInjector] ${e}`,t||"")},c=function(e,t){S.logger.error(`[MessageInjector] ${e}`,t||"")},G=function(e){return new Promise(function(t){return setTimeout(t,e)})};function se(e){if(!e)return new Date().toISOString();try{const t=new Date(e);return isNaN(t.getTime())?(c("Invalid timestamp, using current time",e),new Date().toISOString()):t.toISOString()}catch(t){return c("Failed to parse timestamp, using current time",t),new Date().toISOString()}}function j(e){return!e||typeof e!="string"?!1:/^\d+$/.test(e.trim())}function ae(e){if(e)try{const t={type:"rich"};return e.title&&typeof e.title=="string"&&(t.title=e.title.substring(0,256)),e.description&&typeof e.description=="string"&&(t.description=e.description.substring(0,4096)),e.image?.url&&typeof e.image.url=="string"&&(t.image={url:e.image.url}),e.thumbnail?.url&&typeof e.thumbnail.url=="string"&&(t.thumbnail={url:e.thumbnail.url}),Object.keys(t).length>1?t:void 0}catch(t){c("Failed to validate embed",t);return}}function _(e,t=[]){for(const r of e)try{const o=N.findByStoreName(r);if(o&&(t.length===0||t.every(function(u){return typeof o[u]=="function"})))return d(`Found store: ${r}`),o}catch{}if(t.length>0)try{const r=N.findByProps(...t);if(r)return d(`Found store by props: ${t.join(", ")}`),r}catch{}return null}async function re(e){try{if(D){const t=D.getUser?.(e);if(t)return{username:t.username||"Unknown User",discriminator:t.discriminator||"0",avatar:t.avatar?`https://cdn.discordapp.com/avatars/${e}/${t.avatar}.png`:null}}}catch(t){c("Failed to get user info",t)}return{username:"Unknown User",discriminator:"0",avatar:null}}function ne(e){try{if(A?.getDMFromUserId){const t=A.getDMFromUserId(e);return d(`DM channel for user ${e}: ${t}`),t}}catch(t){c("Failed to get DM channel",t)}return null}function oe(){const e=Date.now(),t=Math.floor(Math.random()*4096);return`${e}${t.toString().padStart(4,"0")}`}async function ie(e){if(!j(e.userId))throw new Error("Invalid user ID");let t=e.username,r=e.avatar;if(!t){const E=await re(e.userId);t=E.username,r||(r=E.avatar??void 0)}const o=se(e.timestamp),u=ae(e.embed),h={id:e.messageId||oe(),channel_id:e.channelId,author:{id:e.userId,username:t||"Unknown User",discriminator:"0",avatar:r??void 0,bot:!1,public_flags:0},content:(e.content||"").substring(0,2e3),timestamp:o,edited_timestamp:null,tts:!1,mention_everyone:!1,mentions:[],mention_roles:[],attachments:[],embeds:u?[u]:[],reactions:[],pinned:!1,type:0,flags:0};return d("Created message object",h),h}function L(e){if(!a.FluxDispatcher)return c("FluxDispatcher not available"),!1;try{return a.FluxDispatcher.dispatch({type:"MESSAGE_CREATE",channelId:e.channel_id,message:e,optimistic:!1,sendMessageOptions:{},isPushNotification:!1}),d("Message injected successfully",e.id),!0}catch(t){return c("Failed to inject message",t),!1}}function w(){try{typeof s.storage.persistentMessages!="object"&&(s.storage.persistentMessages={}),Object.keys(s.storage.persistentMessages).forEach(function(e){Array.isArray(s.storage.persistentMessages[e])||delete s.storage.persistentMessages[e]}),s.storage.persistentMessages=JSON.parse(JSON.stringify(s.storage.persistentMessages)),d("Saved persistent messages",Object.keys(s.storage.persistentMessages).length)}catch(e){c("Failed to save persistent messages",e),s.storage.persistentMessages={}}}async function x(e){try{if(!j(e.fromUserId))return c("Invalid sender user ID"),n.showToast&&n.showToast("\u274C Invalid sender user ID","Small"),!1;let t=e.channelId;if(!t&&e.targetUserId){if(!j(e.targetUserId))return c("Invalid target user ID"),n.showToast&&n.showToast("\u274C Invalid target user ID","Small"),!1;t=ne(e.targetUserId)}if(!t)return c("No valid channel ID found"),n.showToast&&n.showToast("\u274C Could not find DM channel","Small"),!1;const r=await ie({channelId:t,userId:e.fromUserId,content:e.content,username:e.username,avatar:e.avatar,embed:e.embed});e.persistent&&(s.storage.persistentMessages[t]||(s.storage.persistentMessages[t]=[]),s.storage.persistentMessages[t].push(r),w(),d("Message saved to persistent storage",r.id));const o=L(r);return o&&d("Fake message sent successfully"),o}catch(t){return c("Failed to send fake message",t),n.showToast&&n.showToast("\u274C Failed to send message","Small"),!1}}function f(e){if(!s.storage.persistentMessages[e])return;const t=s.storage.persistentMessages[e];if(!Array.isArray(t)){delete s.storage.persistentMessages[e],w();return}d(`Reinjecting ${t.length} messages for channel ${e}`),t.forEach(function(r,o){setTimeout(function(){try{L(r)}catch(u){c("Failed to reinject message",u)}},o*50)})}function le(){try{if(!a.FluxDispatcher)return;const e=q.before("dispatch",a.FluxDispatcher,function(t){if(!s.storage.enabled)return;const r=t[0];if(!(!r||!r.type)){if(s.storage.preventMessageDeletion&&r.type==="MESSAGE_DELETE"){const o=r.id,u=r.channelId;if(u&&s.storage.persistentMessages[u]){const h=s.storage.persistentMessages[u].find(function(E){return E.id===o});h&&(d("Prevented deletion of fake message",o),t[0]={type:"NOOP"},setTimeout(function(){return L(h)},50))}}if(s.storage.preventMessageDeletion&&r.type==="MESSAGE_DELETE_BULK"){const o=r.channelId;if(o&&s.storage.persistentMessages[o]){const u=r.ids||[];s.storage.persistentMessages[o].some(function(h){return u.includes(h.id)})&&(t[0]={type:"NOOP"},setTimeout(function(){return f(o)},100))}}if(r.type==="LOAD_MESSAGES_SUCCESS"||r.type==="LOAD_MESSAGES"){const o=r.channelId;o&&s.storage.persistentMessages[o]&&(setTimeout(function(){return f(o)},200),setTimeout(function(){return f(o)},500),setTimeout(function(){return f(o)},1e3))}if((r.type==="CACHE_LOADED"||r.type==="OVERLAY_INITIALIZE"||r.type==="CHANNEL_UPDATES")&&g&&s.storage.persistentMessages[g]&&setTimeout(function(){return g&&f(g)},300),(r.type==="USER_PROFILE_MODAL_OPEN"||r.type==="USER_PROFILE_MODAL_CLOSE"||r.type==="LAYER_PUSH"||r.type==="LAYER_POP"||r.type==="TYPING_START"||r.type==="TYPING_STOP")&&g&&s.storage.persistentMessages[g]&&(setTimeout(function(){return g&&f(g)},50),setTimeout(function(){return g&&f(g)},300)),r.type==="MESSAGE_UPDATE"){const o=r.message?.channel_id;o&&s.storage.persistentMessages[o]&&setTimeout(function(){return f(o)},100)}}});k.push(e),d("Message persistence system setup with comprehensive event coverage")}catch(e){c("Failed to setup message persistence",e)}}function ce(){F=setInterval(function(){if(P)try{const e=P.getChannelId?.();e&&e!==g&&(g=e,s.storage.persistentMessages[e]&&(f(e),setTimeout(function(){f(e)},200)))}catch{}},1e3),v=setInterval(function(){g&&s.storage.persistentMessages[g]&&f(g)},2e3)}function $(){s.storage.persistentMessages={},w(),d("Cleared all persistent messages"),n.showToast&&n.showToast("\u2705 All fake messages cleared","Check")}function V(e){s.storage.persistentMessages[e]&&(delete s.storage.persistentMessages[e],w(),d(`Cleared messages for channel ${e}`),n.showToast&&n.showToast("\u2705 Channel messages cleared","Check"))}function K(){return s.storage.persistentMessages}async function H(e,t){return await x({targetUserId:e,fromUserId:t,content:"Test message from Message Injector plugin! \u{1F389}",persistent:!0})}async function ue(){try{A=_(["ChannelStore"],["getChannel","getDMFromUserId"]),D=_(["UserStore","CurrentUserStore"],["getUser","getCurrentUser"]),te=_(["MessageStore"],["getMessages","getMessage"]),P=_(["SelectedChannelStore"],["getChannelId"]);const e=A&&D;return e?d("All critical modules loaded"):c("Some modules failed to load"),e}catch(e){return c("Failed to initialize modules",e),!1}}function ge(){try{if(typeof s.storage.persistentMessages!="object"||s.storage.persistentMessages===null){S.logger.warn("[MessageInjector] Corrupted storage detected, resetting..."),s.storage.persistentMessages={};return}Object.keys(s.storage.persistentMessages).forEach(function(e){Array.isArray(s.storage.persistentMessages[e])?(s.storage.persistentMessages[e]=s.storage.persistentMessages[e].filter(function(t){return t&&t.id&&t.channel_id&&t.author&&t.timestamp}),s.storage.persistentMessages[e].length===0&&delete s.storage.persistentMessages[e]):delete s.storage.persistentMessages[e]}),w()}catch(e){c("Failed to recover storage",e),s.storage.persistentMessages={}}}var de={onLoad:async function(){try{if(S.logger.log("[MessageInjector] Loading..."),ge(),await G(1e3),!await ue()){c("Failed to load critical modules"),n.showToast&&n.showToast("\u274C Plugin failed to load","Small");return}if(le(),ce(),s.storage.autoInjectOnStartup){await G(2e3);const e=Object.keys(s.storage.persistentMessages).length;e>0&&(d(`Auto-injecting messages for ${e} channels`),Object.keys(s.storage.persistentMessages).forEach(function(t){setTimeout(function(){f(t)},500)}))}window.__MESSAGE_FAKER__={fakeMessage:x,clearAllMessages:$,clearChannelMessages:V,getAllMessages:K,quickTest:H,reinjectChannel:f,getStatus:function(){return{enabled:s.storage.enabled,messageCount:Object.values(s.storage.persistentMessages).reduce(function(e,t){return e+t.length},0),channelCount:Object.keys(s.storage.persistentMessages).length}}},S.logger.log("[MessageInjector] \u2705 Loaded successfully"),n.showToast&&n.showToast("\u2705 Message Injector loaded!","Check")}catch(e){c("Fatal error during load",e),n.showToast&&n.showToast("\u274C Plugin failed to load","Small")}},onUnload:function(){try{for(const e of k)try{e()}catch{}k.length=0,F&&(clearInterval(F),F=null),v&&(clearInterval(v),v=null),window.__MESSAGE_FAKER__&&delete window.__MESSAGE_FAKER__,S.logger.log("[MessageInjector] Unloaded"),n.showToast&&n.showToast("Plugin unloaded","Check")}catch(e){c("Error during unload",e)}},settings:ee};return m.clearAllMessages=$,m.clearChannelMessages=V,m.default=de,m.fakeMessage=x,m.getAllMessages=K,m.quickTest=H,Object.defineProperty(m,"__esModule",{value:!0}),m})({},vendetta.metro.common,vendetta.metro,vendetta.patcher,vendetta.plugin,vendetta.ui.toasts,vendetta,vendetta.ui.components,vendetta.storage);
