(function(h,s,V,X,a,i,y,ee,te){"use strict";const{FormInput:p,FormSwitch:D,FormSection:T,FormDivider:_,FormRow:De,FormText:E}=ee.Forms,{View:_e,Text:m,ScrollView:ae,TouchableOpacity:I,StyleSheet:se}=s.ReactNative,u=se.create({button:{backgroundColor:"#5865F2",padding:12,borderRadius:8,alignItems:"center",marginVertical:8,marginHorizontal:16},successButton:{backgroundColor:"#3BA55D"},dangerButton:{backgroundColor:"#ED4245"},warningButton:{backgroundColor:"#FAA61A"},buttonText:{color:"white",fontWeight:"bold",fontSize:16},infoText:{color:"#B9BBBE",fontSize:14,marginHorizontal:16,marginVertical:8},warningText:{color:"#FAA61A",fontSize:13,marginHorizontal:16,marginVertical:4},codeText:{fontFamily:"monospace",backgroundColor:"#2F3136",padding:8,borderRadius:4,marginHorizontal:16,marginVertical:4,color:"#DCDDDE"}});function U(){return window.__MESSAGE_FAKER__}function ne(){te.useProxy(a.storage);const[e,t]=s.React.useState(""),[n,r]=s.React.useState(""),[o,g]=s.React.useState(""),[f,A]=s.React.useState(""),[K,Y]=s.React.useState(""),[S,Z]=s.React.useState(""),be=async function(){const l=U();if(!l){i.showToast("\u274C Plugin not ready","Small");return}if(!e.trim()){i.showToast("\u274C Enter target user ID","Small");return}if(!n.trim()){i.showToast("\u274C Enter sender user ID","Small");return}if(!o.trim()&&!f.trim()){i.showToast("\u274C Enter message content or embed","Small");return}const k=f||K||S?{title:f||void 0,description:K||void 0,image:S?{url:S}:void 0,thumbnail:S?{url:S}:void 0,type:"rich"}:void 0;try{await l.fakeMessage({targetUserId:e.trim(),fromUserId:n.trim(),content:o.trim(),embed:k,persistent:!0})&&i.showToast("\u2705 Fake message sent!","Check")}catch{i.showToast("\u274C Failed to send message","Small")}},Se=async function(){const l=U();if(!l){i.showToast("\u274C Plugin not ready","Small");return}if(!e.trim()||!n.trim()){i.showToast("\u274C Fill in both User IDs first","Small");return}try{await l.quickTest(e.trim(),n.trim())}catch{i.showToast("\u274C Test failed","Small")}},Te=async function(){try{const l=await s.clipboard.getString();l&&(t(l.trim()),i.showToast("\u{1F4CB} Pasted target user ID","clipboard"))}catch{i.showToast("Failed to paste","Small")}},Ie=async function(){try{const l=await s.clipboard.getString();l&&(r(l.trim()),i.showToast("\u{1F4CB} Pasted sender user ID","clipboard"))}catch{i.showToast("Failed to paste","Small")}},we=s.React.useMemo(function(){return Object.values(a.storage.persistentMessages||{}).reduce(function(l,k){return l+(Array.isArray(k)?k.length:0)},0)},[a.storage.persistentMessages]),Ce=Object.keys(a.storage.persistentMessages||{}).length;return s.React.createElement(ae,null,s.React.createElement(T,{title:"MESSAGE FAKER"},s.React.createElement(E,{style:u.infoText},"\u{1F4AC} Inject fake messages into DMs from anyone."),s.React.createElement(D,{label:"Enable Plugin",subLabel:"Turn the plugin on/off",value:a.storage.enabled,onValueChange:function(l){a.storage.enabled=l,i.showToast(l?"\u2705 Enabled":"\u274C Disabled","Check")}}),s.React.createElement(D,{label:"Auto-Inject on Startup",subLabel:"Automatically show fake messages when Discord starts",value:a.storage.autoInjectOnStartup,onValueChange:function(l){a.storage.autoInjectOnStartup=l}}),s.React.createElement(D,{label:"Prevent Message Deletion",subLabel:"Fake messages can't be deleted (they reinject)",value:a.storage.preventMessageDeletion,onValueChange:function(l){a.storage.preventMessageDeletion=l}}),s.React.createElement(D,{label:"Debug Mode",subLabel:"Enable detailed logging",value:a.storage.debug,onValueChange:function(l){a.storage.debug=l}})),s.React.createElement(_,null),s.React.createElement(T,{title:"CREATE FAKE MESSAGE"},s.React.createElement(E,{style:u.infoText},"\u{1F4DD} Create a fake message in someone's DM"),s.React.createElement(p,{title:"TARGET USER ID (Whose DM)",placeholder:"User ID of person whose DM you want to inject into",value:e,onChange:t}),s.React.createElement(I,{style:u.button,onPress:Te},s.React.createElement(m,{style:u.buttonText},"\u{1F4CB} Paste Target User ID")),s.React.createElement(p,{title:"FROM USER ID (Who message is from)",placeholder:"User ID of who the message appears to be from",value:n,onChange:r}),s.React.createElement(I,{style:u.button,onPress:Ie},s.React.createElement(m,{style:u.buttonText},"\u{1F4CB} Paste Sender User ID")),s.React.createElement(p,{title:"MESSAGE CONTENT",placeholder:"The message text",value:o,onChange:g}),s.React.createElement(E,{style:u.infoText},"\u{1F4CE} Optional: Add an embed"),s.React.createElement(p,{title:"EMBED TITLE",placeholder:"Optional embed title",value:f,onChange:A}),s.React.createElement(p,{title:"EMBED DESCRIPTION",placeholder:"Optional embed description",value:K,onChange:Y}),s.React.createElement(p,{title:"EMBED IMAGE URL",placeholder:"Optional image URL",value:S,onChange:Z}),s.React.createElement(I,{style:[u.button,u.successButton],onPress:be},s.React.createElement(m,{style:u.buttonText},"\u2709\uFE0F Send Fake Message")),s.React.createElement(I,{style:[u.button,u.warningButton],onPress:Se},s.React.createElement(m,{style:u.buttonText},"\u{1F9EA} Quick Test Message"))),s.React.createElement(_,null),s.React.createElement(T,{title:"CONSOLE API"},s.React.createElement(E,{style:u.infoText},"\u{1F527} You can also use the console for advanced usage:"),s.React.createElement(m,{style:u.codeText},`// Send fake message
__MESSAGE_FAKER__.fakeMessage({
  targetUserId: "USER_ID",
  fromUserId: "USER_ID",
  content: "Hello!",
  persistent: true
});`),s.React.createElement(m,{style:u.codeText},`// With embed
__MESSAGE_FAKER__.fakeMessage({
  targetUserId: "USER_ID",
  fromUserId: "USER_ID",
  content: "Check this out!",
  embed: {
    title: "Cool Title",
    description: "Description",
    image: { url: "https://..." }
  }
});`),s.React.createElement(E,{style:u.infoText},"Open Kettu debug console to use these commands")),s.React.createElement(_,null),s.React.createElement(T,{title:"STATISTICS"},s.React.createElement(E,{style:u.infoText},"\u{1F4CA} Current fake messages: ",we," messages in ",Ce," channels")),s.React.createElement(_,null),s.React.createElement(T,{title:"DANGER ZONE"},s.React.createElement(I,{style:[u.button,u.dangerButton],onPress:function(){const l=U();l&&l.clearAllMessages(),t(""),r(""),g(""),A(""),Y(""),Z("")}},s.React.createElement(m,{style:u.buttonText},"\u{1F5D1}\uFE0F Clear ALL Fake Messages")),s.React.createElement(E,{style:u.warningText},"\u26A0\uFE0F This will remove all fake messages from storage. They will disappear on next reload.")),s.React.createElement(E,{style:[u.infoText,{marginTop:16,marginBottom:32,textAlign:"center"}]},"MessageFaker v1.0.2 for Kettu/Bunny/Vendetta"))}a.storage.enabled??=!0,a.storage.debug??=!1,a.storage.persistentMessages??={},a.storage.autoInjectOnStartup??=!0,a.storage.preventMessageDeletion??=!0;const O=[];let w=null,F=null,re=null,j=null,P=null,ie=null,x=null,v=null;const R={},oe=3e3;let $=!1;const d=function(e,t){a.storage.debug&&y.logger.log(`[MessageInjector] ${e}`,t||"")},c=function(e,t){y.logger.error(`[MessageInjector] ${e}`,t||"")},N=function(e){return new Promise(function(t){return setTimeout(t,e)})};function le(e){if(!e)return new Date().toISOString();try{const t=new Date(e);return isNaN(t.getTime())?(c("Invalid timestamp, using current time",e),new Date().toISOString()):t.toISOString()}catch(t){return c("Failed to parse timestamp, using current time",t),new Date().toISOString()}}function B(e){return!e||typeof e!="string"?!1:/^\d+$/.test(e.trim())}function ce(e){if(e)try{const t={type:"rich"};return e.title&&typeof e.title=="string"&&(t.title=e.title.substring(0,256)),e.description&&typeof e.description=="string"&&(t.description=e.description.substring(0,4096)),e.image?.url&&typeof e.image.url=="string"&&(t.image={url:e.image.url}),e.thumbnail?.url&&typeof e.thumbnail.url=="string"&&(t.thumbnail={url:e.thumbnail.url}),Object.keys(t).length>1?t:void 0}catch(t){c("Failed to validate embed",t);return}}function M(e,t=[]){for(const n of e)try{const r=V.findByStoreName(n);if(r&&(t.length===0||t.every(function(o){return typeof r[o]=="function"})))return d(`Found store: ${n}`),r}catch{}if(t.length>0)try{const n=V.findByProps(...t);if(n)return d(`Found store by props: ${t.join(", ")}`),n}catch{}return null}async function ue(e){try{if(F){const t=F.getUser?.(e);if(t){const n={username:t.username||"Unknown User",discriminator:t.discriminator||"0",global_name:t.globalName||t.global_name||void 0,avatar:t.avatar?`https://cdn.discordapp.com/avatars/${e}/${t.avatar}.${t.avatar.startsWith("a_")?"gif":"png"}`:null,public_flags:t.publicFlags||t.public_flags||0};if(t.avatarDecorationData||t.avatar_decoration_data){const o=t.avatarDecorationData||t.avatar_decoration_data;n.avatar_decoration_data={asset:o.asset,sku_id:o.skuId||o.sku_id}}else if(t.avatarDecoration||t.avatar_decoration){const o=t.avatarDecoration||t.avatar_decoration;n.avatar_decoration_data={asset:o,sku_id:void 0}}const r=t.clan||t.primaryGuild||t.primary_guild;return r&&(n.clan={identity_guild_id:r.identityGuildId||r.identity_guild_id||null,identity_enabled:r.identityEnabled??r.identity_enabled??!1,tag:r.tag||null,badge:r.badge||null}),n}}}catch(t){c("Failed to get user info",t)}return{username:"Unknown User",discriminator:"0",avatar:null,public_flags:0}}function z(e){try{if(w?.getDMFromUserId){const t=w.getDMFromUserId(e);return d(`DM channel for user ${e}: ${t}`),t}}catch(t){c("Failed to get DM channel",t)}return null}async function de(e){try{let t=z(e);if(!t&&P)try{const n=P.getPrivateChannelIds?.();if(n)for(const r of n){const o=w?.getChannel?.(r);if(o?.type===1&&o.recipients?.includes(e)){t=r;break}}t||(s.FluxDispatcher.dispatch({type:"CHANNEL_SELECT",channelId:null,guildId:null}),await N(100),t=z(e))}catch(n){c("Failed to ensure DM channel",n)}return t}catch(t){return c("Failed to ensure DM channel",t),null}}function ge(){const e=Date.now(),t=Math.floor(Math.random()*4096);return`${e}${t.toString().padStart(4,"0")}`}async function fe(e){if(!B(e.userId))throw new Error("Invalid user ID");const t=await ue(e.userId);let n=e.username||t.username,r=e.avatar||t.avatar;const o=le(e.timestamp),g=ce(e.embed),f={id:e.messageId||ge(),channel_id:e.channelId,author:{id:e.userId,username:n||"Unknown User",global_name:t.global_name,discriminator:t.discriminator||"0",avatar:r?r.split("/").pop()?.split(".")[0]:null,avatar_decoration_data:t.avatar_decoration_data,clan:t.clan,public_flags:t.public_flags||0,bot:!1},content:(e.content||"").substring(0,2e3),timestamp:o,edited_timestamp:null,tts:!1,mention_everyone:!1,mentions:[],mention_roles:[],attachments:[],embeds:g?[g]:[],reactions:[],pinned:!1,type:0,flags:0};return d("Created message object",f),f}function H(e,t){try{if(!s.FluxDispatcher)return;s.FluxDispatcher.dispatch({type:"MESSAGE_ACK",channelId:e,messageId:t,manual:!1,local:!0}),d(`Acknowledged message ${t} in channel ${e}`)}catch(n){c("Failed to acknowledge message",n)}}function he(e,t){try{if(!s.FluxDispatcher)return;s.FluxDispatcher.dispatch({type:"CHANNEL_UPDATES",channels:[{id:e,last_message_id:t.id}]}),d(`Updated channel state for ${e}`)}catch(n){c("Failed to update channel state",n)}}function L(e,t=!1){if(!s.FluxDispatcher)return c("FluxDispatcher not available"),!1;try{return s.FluxDispatcher.dispatch({type:"MESSAGE_CREATE",channelId:e.channel_id,message:e,optimistic:!1,sendMessageOptions:{},isPushNotification:!1,...t&&{silent:!0}}),d(`Message ${t?"silently ":""}injected successfully`,e.id),t&&setTimeout(function(){H(e.channel_id,e.id)},100),setTimeout(function(){he(e.channel_id,e)},150),!0}catch(n){return c("Failed to inject message",n),!1}}function C(){try{typeof a.storage.persistentMessages!="object"&&(a.storage.persistentMessages={}),Object.keys(a.storage.persistentMessages).forEach(function(e){Array.isArray(a.storage.persistentMessages[e])||delete a.storage.persistentMessages[e]}),a.storage.persistentMessages=JSON.parse(JSON.stringify(a.storage.persistentMessages)),d("Saved persistent messages",Object.keys(a.storage.persistentMessages).length)}catch(e){c("Failed to save persistent messages",e),a.storage.persistentMessages={}}}async function G(e){try{if(!B(e.fromUserId))return c("Invalid sender user ID"),i.showToast&&i.showToast("\u274C Invalid sender user ID","Small"),!1;let t=e.channelId;if(!t&&e.targetUserId){if(!B(e.targetUserId))return c("Invalid target user ID"),i.showToast&&i.showToast("\u274C Invalid target user ID","Small"),!1;t=await de(e.targetUserId)}if(!t)return c("No valid channel ID found"),i.showToast&&i.showToast("\u274C Could not find DM channel","Small"),!1;const n=await fe({channelId:t,userId:e.fromUserId,content:e.content,username:e.username,avatar:e.avatar,embed:e.embed});e.persistent&&(a.storage.persistentMessages[t]||(a.storage.persistentMessages[t]=[]),a.storage.persistentMessages[t].push(n),C(),d("Message saved to persistent storage",n.id));const r=L(n,!1);return r&&d("Fake message sent successfully"),r}catch(t){return c("Failed to send fake message",t),i.showToast&&i.showToast("\u274C Failed to send message","Small"),!1}}function b(e,t=!1){if(!a.storage.persistentMessages[e])return;const n=Date.now();if(!t&&R[e]&&n-R[e]<oe){d(`Skipping reinject for ${e} - too soon (${n-R[e]}ms ago)`);return}const r=a.storage.persistentMessages[e];if(!Array.isArray(r)){delete a.storage.persistentMessages[e],C();return}d(`Reinjecting ${r.length} messages for channel ${e}`),R[e]=n;let o=r[r.length-1]?.id;r.forEach(function(g,f){setTimeout(function(){try{L(g,!0)}catch(A){c("Failed to reinject message",A)}},f*50)}),o&&setTimeout(function(){H(e,o)},r.length*50+200)}function Ee(){try{if(!s.FluxDispatcher)return;const e=X.before("dispatch",s.FluxDispatcher,function(t){if(!a.storage.enabled)return;const n=t[0];if(!(!n||!n.type)){if(a.storage.preventMessageDeletion&&n.type==="MESSAGE_DELETE"){const r=n.id,o=n.channelId;if(o&&a.storage.persistentMessages[o]){const g=a.storage.persistentMessages[o].find(function(f){return f.id===r});g&&(d("Prevented deletion of fake message",r),t[0]={type:"NOOP"},setTimeout(function(){return L(g,!0)},100))}}if(a.storage.preventMessageDeletion&&n.type==="MESSAGE_DELETE_BULK"){const r=n.channelId;if(r&&a.storage.persistentMessages[r]){const o=n.ids||[];a.storage.persistentMessages[r].some(function(g){return o.includes(g.id)})&&(t[0]={type:"NOOP"},setTimeout(function(){return b(r,!0)},200))}}if(n.type==="LOAD_MESSAGES_SUCCESS"){const r=n.channelId;r&&a.storage.persistentMessages[r]&&setTimeout(function(){return b(r)},500)}n.type==="CONNECTION_OPEN"&&$&&Object.keys(a.storage.persistentMessages).forEach(function(r){setTimeout(function(){b(r,!0)},1e3)})}});O.push(e),d("Message persistence system setup with minimal event coverage")}catch(e){c("Failed to setup message persistence",e)}}function me(){v=setInterval(function(){if(j)try{const e=j.getChannelId?.();if(e&&e!==x){const t=x;x=e,d(`Channel switched from ${t} to ${e}`),a.storage.persistentMessages[e]&&setTimeout(function(){b(e)},300)}}catch{}},1e3)}function W(){a.storage.persistentMessages={},C(),d("Cleared all persistent messages"),i.showToast&&i.showToast("\u2705 All fake messages cleared","Check")}function q(e){a.storage.persistentMessages[e]&&(delete a.storage.persistentMessages[e],C(),d(`Cleared messages for channel ${e}`),i.showToast&&i.showToast("\u2705 Channel messages cleared","Check"))}function J(){return a.storage.persistentMessages}async function Q(e,t){return await G({targetUserId:e,fromUserId:t,content:"Test message from Message Injector plugin! \u{1F389}",persistent:!0})}async function ye(){try{w=M(["ChannelStore"],["getChannel","getDMFromUserId"]),F=M(["UserStore","CurrentUserStore"],["getUser","getCurrentUser"]),re=M(["MessageStore"],["getMessages","getMessage"]),j=M(["SelectedChannelStore"],["getChannelId"]),P=M(["PrivateChannelStore"],["getPrivateChannelIds"]),ie=M(["RelationshipStore"],["getRelationships"]);const e=w&&F;return e?d("All critical modules loaded"):c("Some modules failed to load"),e}catch(e){return c("Failed to initialize modules",e),!1}}function pe(){try{if(typeof a.storage.persistentMessages!="object"||a.storage.persistentMessages===null){y.logger.warn("[MessageInjector] Corrupted storage detected, resetting..."),a.storage.persistentMessages={};return}Object.keys(a.storage.persistentMessages).forEach(function(e){Array.isArray(a.storage.persistentMessages[e])?(a.storage.persistentMessages[e]=a.storage.persistentMessages[e].filter(function(t){return t&&t.id&&t.channel_id&&t.author&&t.timestamp}),a.storage.persistentMessages[e].length===0&&delete a.storage.persistentMessages[e]):delete a.storage.persistentMessages[e]}),C()}catch(e){c("Failed to recover storage",e),a.storage.persistentMessages={}}}var Me={onLoad:async function(){try{if(y.logger.log("[MessageInjector] Loading..."),pe(),await N(1e3),!await ye()){c("Failed to load critical modules"),i.showToast&&i.showToast("\u274C Plugin failed to load","Small");return}if(Ee(),me(),a.storage.autoInjectOnStartup){await N(2e3);const e=Object.keys(a.storage.persistentMessages).length;e>0&&(d(`Auto-injecting messages for ${e} channels on startup`),Object.keys(a.storage.persistentMessages).forEach(function(t){setTimeout(function(){b(t,!0)},500)})),setTimeout(function(){$=!0,d("Startup injection complete")},3e3)}else $=!0;window.__MESSAGE_FAKER__={fakeMessage:G,clearAllMessages:W,clearChannelMessages:q,getAllMessages:J,quickTest:Q,reinjectChannel:function(e){return b(e,!0)},getStatus:function(){return{enabled:a.storage.enabled,messageCount:Object.values(a.storage.persistentMessages).reduce(function(e,t){return e+t.length},0),channelCount:Object.keys(a.storage.persistentMessages).length}}},y.logger.log("[MessageInjector] \u2705 Loaded successfully")}catch(e){c("Fatal error during load",e),i.showToast&&i.showToast("\u274C Plugin failed to load","Small")}},onUnload:function(){try{for(const e of O)try{e()}catch{}O.length=0,v&&(clearInterval(v),v=null),window.__MESSAGE_FAKER__&&delete window.__MESSAGE_FAKER__,y.logger.log("[MessageInjector] Unloaded"),i.showToast&&i.showToast("Plugin unloaded","Check")}catch(e){c("Error during unload",e)}},settings:ne};return h.clearAllMessages=W,h.clearChannelMessages=q,h.default=Me,h.fakeMessage=G,h.getAllMessages=J,h.quickTest=Q,Object.defineProperty(h,"__esModule",{value:!0}),h})({},vendetta.metro.common,vendetta.metro,vendetta.patcher,vendetta.plugin,vendetta.ui.toasts,vendetta,vendetta.ui.components,vendetta.storage);
