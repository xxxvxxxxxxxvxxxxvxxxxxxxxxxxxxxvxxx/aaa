(function(E,r,G,O,a,i,C,Z,Q){"use strict";const{FormInput:I,FormSwitch:w,FormSection:p,FormDivider:F,FormRow:De,FormText:M}=Z.Forms,{View:pe,Text:S,ScrollView:X,TouchableOpacity:T,StyleSheet:ee}=r.ReactNative,d=ee.create({button:{backgroundColor:"#5865F2",padding:12,borderRadius:8,alignItems:"center",marginVertical:8,marginHorizontal:16},successButton:{backgroundColor:"#3BA55D"},dangerButton:{backgroundColor:"#ED4245"},warningButton:{backgroundColor:"#FAA61A"},buttonText:{color:"white",fontWeight:"bold",fontSize:16},infoText:{color:"#B9BBBE",fontSize:14,marginHorizontal:16,marginVertical:8},warningText:{color:"#FAA61A",fontSize:13,marginHorizontal:16,marginVertical:4},codeText:{fontFamily:"monospace",backgroundColor:"#2F3136",padding:8,borderRadius:4,marginHorizontal:16,marginVertical:4,color:"#DCDDDE"}});function P(){return window.__MESSAGE_FAKER__}function te(){Q.useProxy(a.storage);const[e,t]=r.React.useState(""),[s,n]=r.React.useState(""),[o,g]=r.React.useState(""),[f,W]=r.React.useState(""),[B,q]=r.React.useState(""),[D,Y]=r.React.useState(""),ye=async function(){const c=P();if(!c){i.showToast("\u274C Plugin not ready","Small");return}if(!e.trim()){i.showToast("\u274C Enter target user ID","Small");return}if(!s.trim()){i.showToast("\u274C Enter sender user ID","Small");return}if(!o.trim()&&!f.trim()){i.showToast("\u274C Enter message content or embed","Small");return}const U=f||B||D?{title:f||void 0,description:B||void 0,image:D?{url:D}:void 0,thumbnail:D?{url:D}:void 0,type:"rich"}:void 0;try{await c.fakeMessage({targetUserId:e.trim(),fromUserId:s.trim(),content:o.trim(),embed:U,persistent:!0})&&i.showToast("\u2705 Fake message sent!","Check")}catch{i.showToast("\u274C Failed to send message","Small")}},me=async function(){const c=P();if(!c){i.showToast("\u274C Plugin not ready","Small");return}if(!e.trim()||!s.trim()){i.showToast("\u274C Fill in both User IDs first","Small");return}try{await c.quickTest(e.trim(),s.trim())}catch{i.showToast("\u274C Test failed","Small")}},Se=async function(){try{const c=await r.clipboard.getString();c&&(t(c.trim()),i.showToast("\u{1F4CB} Pasted target user ID","clipboard"))}catch{i.showToast("Failed to paste","Small")}},Ce=async function(){try{const c=await r.clipboard.getString();c&&(n(c.trim()),i.showToast("\u{1F4CB} Pasted sender user ID","clipboard"))}catch{i.showToast("Failed to paste","Small")}},Ie=r.React.useMemo(function(){return Object.values(a.storage.persistentMessages||{}).reduce(function(c,U){return c+(Array.isArray(U)?U.length:0)},0)},[a.storage.persistentMessages]),be=Object.keys(a.storage.persistentMessages||{}).length;return r.React.createElement(X,null,r.React.createElement(p,{title:"MESSAGE FAKER"},r.React.createElement(M,{style:d.infoText},"\u{1F4AC} Inject fake messages into DMs from anyone."),r.React.createElement(w,{label:"Enable Plugin",subLabel:"Turn the plugin on/off",value:a.storage.enabled,onValueChange:function(c){a.storage.enabled=c,i.showToast(c?"\u2705 Enabled":"\u274C Disabled","Check")}}),r.React.createElement(w,{label:"Auto-Inject on Startup",subLabel:"Automatically show fake messages when Discord starts",value:a.storage.autoInjectOnStartup,onValueChange:function(c){a.storage.autoInjectOnStartup=c}}),r.React.createElement(w,{label:"Prevent Message Deletion",subLabel:"Fake messages can't be deleted (they reinject)",value:a.storage.preventMessageDeletion,onValueChange:function(c){a.storage.preventMessageDeletion=c}}),r.React.createElement(w,{label:"Debug Mode",subLabel:"Enable detailed logging",value:a.storage.debug,onValueChange:function(c){a.storage.debug=c}})),r.React.createElement(F,null),r.React.createElement(p,{title:"CREATE FAKE MESSAGE"},r.React.createElement(M,{style:d.infoText},"\u{1F4DD} Create a fake message in someone's DM"),r.React.createElement(I,{title:"TARGET USER ID (Whose DM)",placeholder:"User ID of person whose DM you want to inject into",value:e,onChange:t}),r.React.createElement(T,{style:d.button,onPress:Se},r.React.createElement(S,{style:d.buttonText},"\u{1F4CB} Paste Target User ID")),r.React.createElement(I,{title:"FROM USER ID (Who message is from)",placeholder:"User ID of who the message appears to be from",value:s,onChange:n}),r.React.createElement(T,{style:d.button,onPress:Ce},r.React.createElement(S,{style:d.buttonText},"\u{1F4CB} Paste Sender User ID")),r.React.createElement(I,{title:"MESSAGE CONTENT",placeholder:"The message text",value:o,onChange:g}),r.React.createElement(M,{style:d.infoText},"\u{1F4CE} Optional: Add an embed"),r.React.createElement(I,{title:"EMBED TITLE",placeholder:"Optional embed title",value:f,onChange:W}),r.React.createElement(I,{title:"EMBED DESCRIPTION",placeholder:"Optional embed description",value:B,onChange:q}),r.React.createElement(I,{title:"EMBED IMAGE URL",placeholder:"Optional image URL",value:D,onChange:Y}),r.React.createElement(T,{style:[d.button,d.successButton],onPress:ye},r.React.createElement(S,{style:d.buttonText},"\u2709\uFE0F Send Fake Message")),r.React.createElement(T,{style:[d.button,d.warningButton],onPress:me},r.React.createElement(S,{style:d.buttonText},"\u{1F9EA} Quick Test Message"))),r.React.createElement(F,null),r.React.createElement(p,{title:"CONSOLE API"},r.React.createElement(M,{style:d.infoText},"\u{1F527} You can also use the console for advanced usage:"),r.React.createElement(S,{style:d.codeText},`// Send fake message
__MESSAGE_FAKER__.fakeMessage({
  targetUserId: "USER_ID",
  fromUserId: "USER_ID",
  content: "Hello!",
  persistent: true
});`),r.React.createElement(S,{style:d.codeText},`// With embed
__MESSAGE_FAKER__.fakeMessage({
  targetUserId: "USER_ID",
  fromUserId: "USER_ID",
  content: "Check this out!",
  embed: {
    title: "Cool Title",
    description: "Description",
    image: { url: "https://..." }
  }
});`),r.React.createElement(M,{style:d.infoText},"Open Kettu debug console to use these commands")),r.React.createElement(F,null),r.React.createElement(p,{title:"STATISTICS"},r.React.createElement(M,{style:d.infoText},"\u{1F4CA} Current fake messages: ",Ie," messages in ",be," channels")),r.React.createElement(F,null),r.React.createElement(p,{title:"DANGER ZONE"},r.React.createElement(T,{style:[d.button,d.dangerButton],onPress:function(){const c=P();c&&c.clearAllMessages(),t(""),n(""),g(""),W(""),q(""),Y("")}},r.React.createElement(S,{style:d.buttonText},"\u{1F5D1}\uFE0F Clear ALL Fake Messages")),r.React.createElement(M,{style:d.warningText},"\u26A0\uFE0F This will remove all fake messages from storage. They will disappear on next reload.")),r.React.createElement(M,{style:[d.infoText,{marginTop:16,marginBottom:32,textAlign:"center"}]},"MessageFaker v1.0.2 for Kettu/Bunny/Vendetta"))}a.storage.enabled??=!0,a.storage.debug??=!1,a.storage.persistentMessages??={},a.storage.autoInjectOnStartup??=!0,a.storage.preventMessageDeletion??=!0,a.storage.fakeDMChannels??={};const _=[];let y=null,k=null,ae=null,v=null,m=null,se=null,j=null,R=null;const u=function(e,t){a.storage.debug&&C.logger.log(`[MessageInjector] ${e}`,t||"")},l=function(e,t){C.logger.error(`[MessageInjector] ${e}`,t||"")},L=function(e){return new Promise(function(t){return setTimeout(t,e)})};function ne(e){if(!e)return new Date().toISOString();try{const t=new Date(e);return isNaN(t.getTime())?(l("Invalid timestamp, using current time",e),new Date().toISOString()):t.toISOString()}catch(t){return l("Failed to parse timestamp, using current time",t),new Date().toISOString()}}function $(e){return!e||typeof e!="string"?!1:/^\d+$/.test(e.trim())}function re(e){if(e)try{const t={type:"rich"};return e.title&&typeof e.title=="string"&&(t.title=e.title.substring(0,256)),e.description&&typeof e.description=="string"&&(t.description=e.description.substring(0,4096)),e.image?.url&&typeof e.image.url=="string"&&(t.image={url:e.image.url}),e.thumbnail?.url&&typeof e.thumbnail.url=="string"&&(t.thumbnail={url:e.thumbnail.url}),Object.keys(t).length>1?t:void 0}catch(t){l("Failed to validate embed",t);return}}function b(e,t=[]){for(const s of e)try{const n=G.findByStoreName(s);if(n&&(t.length===0||t.every(function(o){return typeof n[o]=="function"})))return u(`Found store: ${s}`),n}catch{}if(t.length>0)try{const s=G.findByProps(...t);if(s)return u(`Found store by props: ${t.join(", ")}`),s}catch{}return null}async function oe(e){try{if(k){const t=k.getUser?.(e);if(t){const s={username:t.username||"Unknown User",discriminator:t.discriminator||"0",global_name:t.globalName||t.global_name||void 0,avatar:t.avatar?`https://cdn.discordapp.com/avatars/${e}/${t.avatar}.${t.avatar.startsWith("a_")?"gif":"png"}`:null,public_flags:t.publicFlags||t.public_flags||0};if(t.avatarDecorationData||t.avatar_decoration_data){const o=t.avatarDecorationData||t.avatar_decoration_data;s.avatar_decoration_data={asset:o.asset,sku_id:o.skuId||o.sku_id}}else if(t.avatarDecoration||t.avatar_decoration){const o=t.avatarDecoration||t.avatar_decoration;s.avatar_decoration_data={asset:o,sku_id:void 0}}const n=t.clan||t.primaryGuild||t.primary_guild;return n&&(s.clan={identity_guild_id:n.identityGuildId||n.identity_guild_id||null,identity_enabled:n.identityEnabled??n.identity_enabled??!1,tag:n.tag||null,badge:n.badge||null}),s}}}catch(t){l("Failed to get user info",t)}return{username:"Unknown User",discriminator:"0",avatar:null,public_flags:0}}function K(e){try{if(y?.getDMFromUserId){const t=y.getDMFromUserId(e);return u(`DM channel for user ${e}: ${t}`),t}}catch(t){l("Failed to get DM channel",t)}return null}async function ie(e){try{let t=K(e);if(!t&&m)try{const s=m.getPrivateChannelIds?.();if(s)for(const n of s){const o=y?.getChannel?.(n);if(o?.type===1&&o.recipients?.includes(e)){t=n;break}}t||(r.FluxDispatcher.dispatch({type:"CHANNEL_SELECT",channelId:null,guildId:null}),await L(100),t=K(e))}catch(s){l("Failed to ensure DM channel",s)}return t}catch(t){return l("Failed to ensure DM channel",t),null}}function le(){const e=Date.now(),t=Math.floor(Math.random()*4096);return`${e}${t.toString().padStart(4,"0")}`}async function ce(e){if(!$(e.userId))throw new Error("Invalid user ID");const t=await oe(e.userId);let s=e.username||t.username,n=e.avatar||t.avatar;const o=ne(e.timestamp),g=re(e.embed),f={id:e.messageId||le(),channel_id:e.channelId,author:{id:e.userId,username:s||"Unknown User",global_name:t.global_name,discriminator:t.discriminator||"0",avatar:n?n.split("/").pop()?.split(".")[0]:null,avatar_decoration_data:t.avatar_decoration_data,clan:t.clan,public_flags:t.public_flags||0,bot:!1},content:(e.content||"").substring(0,2e3),timestamp:o,edited_timestamp:null,tts:!1,mention_everyone:!1,mentions:[],mention_roles:[],attachments:[],embeds:g?[g]:[],reactions:[],pinned:!1,type:0,flags:0};return u("Created message object",f),f}function N(e){if(!r.FluxDispatcher)return l("FluxDispatcher not available"),!1;try{return r.FluxDispatcher.dispatch({type:"MESSAGE_CREATE",channelId:e.channel_id,message:e,optimistic:!1}),u("Message injected successfully",e.id),!0}catch(t){return l("Failed to inject message",t),!1}}function A(){try{typeof a.storage.persistentMessages!="object"&&(a.storage.persistentMessages={}),Object.keys(a.storage.persistentMessages).forEach(function(e){Array.isArray(a.storage.persistentMessages[e])||delete a.storage.persistentMessages[e]}),a.storage.persistentMessages=JSON.parse(JSON.stringify(a.storage.persistentMessages)),a.storage.fakeDMChannels=JSON.parse(JSON.stringify(a.storage.fakeDMChannels)),u("Saved persistent messages and fake DM channels")}catch(e){l("Failed to save persistent messages",e),a.storage.persistentMessages={},a.storage.fakeDMChannels={}}}function de(){if(!m){l("PrivateChannelStore not available for patching");return}try{if(m.getPrivateChannelIds){const e=O.after("getPrivateChannelIds",m,function(t,s){if(!s||!Array.isArray(s))return s;const n=Object.keys(a.storage.fakeDMChannels),o=[...new Set([...s,...n])];return u(`Injected ${n.length} fake DM channels into list`),o});_.push(e),u("Patched PrivateChannelStore.getPrivateChannelIds")}}catch(e){l("Failed to patch PrivateChannelStore",e)}}function ue(){if(!y){l("ChannelStore not available for patching");return}try{if(y.getChannel){const e=O.after("getChannel",y,function(t,s){const n=t[0];if(a.storage.fakeDMChannels[n]){const o=a.storage.fakeDMChannels[n],g=a.storage.persistentMessages[n]||[],f=g[g.length-1];return s||{id:n,type:1,recipients:[o.userId],last_message_id:f?.id||null,lastMessageId:f?.id||null}}return s});_.push(e),u("Patched ChannelStore.getChannel")}}catch(e){l("Failed to patch ChannelStore",e)}}async function x(e){try{if(!$(e.fromUserId))return l("Invalid sender user ID"),i.showToast&&i.showToast("\u274C Invalid sender user ID","Small"),!1;let t=e.channelId;if(!t&&e.targetUserId){if(!$(e.targetUserId))return l("Invalid target user ID"),i.showToast&&i.showToast("\u274C Invalid target user ID","Small"),!1;t=await ie(e.targetUserId)}if(!t)return l("No valid channel ID found"),i.showToast&&i.showToast("\u274C Could not find DM channel","Small"),!1;const s=await ce({channelId:t,userId:e.fromUserId,content:e.content,username:e.username,avatar:e.avatar,embed:e.embed});e.persistent&&(a.storage.persistentMessages[t]||(a.storage.persistentMessages[t]=[]),new Set(a.storage.persistentMessages[t].map(function(o){return o.id})).has(s.id)||(a.storage.persistentMessages[t].push(s),u(`Added message ${s.id} to channel ${t}`)),a.storage.fakeDMChannels[t]||(a.storage.fakeDMChannels[t]={userId:e.targetUserId||e.fromUserId,createdAt:Date.now(),senderIds:[]},u(`Registered fake DM channel: ${t}`)),a.storage.fakeDMChannels[t].senderIds||(a.storage.fakeDMChannels[t].senderIds=[]),a.storage.fakeDMChannels[t].senderIds.includes(e.fromUserId)||(a.storage.fakeDMChannels[t].senderIds.push(e.fromUserId),u(`Added sender ${e.fromUserId} to channel ${t}`)),A(),u("Message saved to persistent storage",s.id));const n=N(s);if(n&&(u("Fake message sent successfully"),m))try{r.FluxDispatcher.dispatch({type:"CHANNEL_UPDATES",channels:[{id:t,last_message_id:s.id}]})}catch(o){l("Failed to update channel list",o)}return n}catch(t){return l("Failed to send fake message",t),i.showToast&&i.showToast("\u274C Failed to send message","Small"),!1}}function h(e){if(!a.storage.persistentMessages[e])return;const t=a.storage.persistentMessages[e];if(!Array.isArray(t)){delete a.storage.persistentMessages[e],A();return}u(`Reinjecting ${t.length} messages for channel ${e}`),t.forEach(function(s,n){setTimeout(function(){try{N(s)}catch(o){l("Failed to reinject message",o)}},n*50)})}function ge(){try{if(!r.FluxDispatcher)return;const e=O.before("dispatch",r.FluxDispatcher,function(t){if(!a.storage.enabled)return;const s=t[0];if(!(!s||!s.type)){if(a.storage.preventMessageDeletion&&s.type==="MESSAGE_DELETE"){const n=s.id,o=s.channelId;if(o&&a.storage.persistentMessages[o]){const g=a.storage.persistentMessages[o].find(function(f){return f.id===n});g&&(u("Prevented deletion of fake message",n),t[0]={type:"NOOP"},setTimeout(function(){return N(g)},100))}}if(a.storage.preventMessageDeletion&&s.type==="MESSAGE_DELETE_BULK"){const n=s.channelId;if(n&&a.storage.persistentMessages[n]){const o=s.ids||[];a.storage.persistentMessages[n].some(function(g){return o.includes(g.id)})&&(t[0]={type:"NOOP"},setTimeout(function(){return h(n)},200))}}if(s.type==="CHANNEL_SELECT"){const n=s.channelId;n&&a.storage.persistentMessages[n]&&setTimeout(function(){return h(n)},300)}if(s.type==="LOAD_MESSAGES_SUCCESS"||s.type==="LOAD_MESSAGES"||s.type==="LOCAL_MESSAGES_LOADED"){const n=s.channelId;n&&a.storage.persistentMessages[n]&&setTimeout(function(){return h(n)},500)}if(s.type==="MESSAGE_UPDATE"){const n=s.message?.channel_id,o=s.message?.id;if(n&&o&&a.storage.persistentMessages[n]){const g=a.storage.persistentMessages[n];Array.isArray(g)&&(g.some(function(f){return f&&f.id===o})||setTimeout(function(){return h(n)},100))}}if((s.type==="CHANNEL_UPDATES"||s.type==="CACHE_LOADED"||s.type==="OVERLAY_INITIALIZE"||s.type==="CONNECTION_OPEN")&&v){const n=v.getChannelId?.();n&&a.storage.persistentMessages[n]&&setTimeout(function(){return h(n)},600)}}});_.push(e),u("Message persistence system setup")}catch(e){l("Failed to setup message persistence",e)}}function fe(){R=setInterval(function(){if(v)try{const e=v.getChannelId?.();if(e&&e!==j){const t=j;j=e,u(`Channel switched from ${t} to ${e}`),a.storage.persistentMessages[e]&&setTimeout(function(){h(e)},300)}}catch{}},1e3)}function V(){a.storage.persistentMessages={},a.storage.fakeDMChannels={},A(),u("Cleared all persistent messages and fake DM channels"),i.showToast&&i.showToast("\u2705 All fake messages cleared","Check")}function H(e){a.storage.persistentMessages[e]&&(delete a.storage.persistentMessages[e],delete a.storage.fakeDMChannels[e],A(),u(`Cleared messages for channel ${e}`),i.showToast&&i.showToast("\u2705 Channel messages cleared","Check"))}function z(){return a.storage.persistentMessages}async function J(e,t){return await x({targetUserId:e,fromUserId:t,content:"Test message from Message Injector plugin! \u{1F389}",persistent:!0})}async function he(){try{y=b(["ChannelStore"],["getChannel","getDMFromUserId"]),k=b(["UserStore","CurrentUserStore"],["getUser","getCurrentUser"]),ae=b(["MessageStore"],["getMessages","getMessage"]),v=b(["SelectedChannelStore"],["getChannelId"]),m=b(["PrivateChannelStore"],["getPrivateChannelIds"]),se=b(["RelationshipStore"],["getRelationships"]);const e=y&&k&&m;return e?u("All critical modules loaded"):l("Some modules failed to load"),e}catch(e){return l("Failed to initialize modules",e),!1}}function Ee(){try{if(typeof a.storage.persistentMessages!="object"||a.storage.persistentMessages===null){C.logger.warn("[MessageInjector] Corrupted storage detected, resetting..."),a.storage.persistentMessages={},a.storage.fakeDMChannels={};return}Object.keys(a.storage.persistentMessages).forEach(function(e){Array.isArray(a.storage.persistentMessages[e])?(a.storage.persistentMessages[e]=a.storage.persistentMessages[e].filter(function(t){return t&&t.id&&t.channel_id&&t.author&&t.timestamp}),a.storage.persistentMessages[e].length===0&&delete a.storage.persistentMessages[e]):delete a.storage.persistentMessages[e]}),A()}catch(e){l("Failed to recover storage",e),a.storage.persistentMessages={},a.storage.fakeDMChannels={}}}var Me={onLoad:async function(){try{if(C.logger.log("[MessageInjector] Loading (DM List Interceptor Edition)..."),Ee(),await L(1e3),!await he()){l("Failed to load critical modules"),i.showToast&&i.showToast("\u274C Plugin failed to load","Small");return}if(de(),ue(),ge(),fe(),a.storage.autoInjectOnStartup){await L(2e3);const e=Object.keys(a.storage.persistentMessages).length;e>0&&(u(`Auto-injecting messages for ${e} channels on startup`),Object.keys(a.storage.persistentMessages).forEach(function(t){setTimeout(function(){h(t)},500)}))}window.__MESSAGE_FAKER__={fakeMessage:x,clearAllMessages:V,clearChannelMessages:H,getAllMessages:z,quickTest:J,reinjectChannel:function(e){return h(e)},reinjectAll:function(){Object.keys(a.storage.persistentMessages).forEach(function(e){h(e)})},getStatus:function(){return{enabled:a.storage.enabled,messageCount:Object.values(a.storage.persistentMessages).reduce(function(e,t){return e+t.length},0),channelCount:Object.keys(a.storage.persistentMessages).length,fakeDMCount:Object.keys(a.storage.fakeDMChannels).length}},getFakeDMChannels:function(){return a.storage.fakeDMChannels}},C.logger.log("[MessageInjector] \u2705 Loaded successfully (DM List Interceptor Edition)")}catch(e){l("Fatal error during load",e),i.showToast&&i.showToast("\u274C Plugin failed to load","Small")}},onUnload:function(){try{for(const e of _)try{e()}catch{}_.length=0,R&&(clearInterval(R),R=null),window.__MESSAGE_FAKER__&&delete window.__MESSAGE_FAKER__,C.logger.log("[MessageInjector] Unloaded"),i.showToast&&i.showToast("Plugin unloaded","Check")}catch(e){l("Error during unload",e)}},settings:te};return E.clearAllMessages=V,E.clearChannelMessages=H,E.default=Me,E.fakeMessage=x,E.getAllMessages=z,E.quickTest=J,Object.defineProperty(E,"__esModule",{value:!0}),E})({},vendetta.metro.common,vendetta.metro,vendetta.patcher,vendetta.plugin,vendetta.ui.toasts,vendetta,vendetta.ui.components,vendetta.storage);
