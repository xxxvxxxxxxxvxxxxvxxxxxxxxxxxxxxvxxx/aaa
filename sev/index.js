(function(y,s,$,Z,a,i,M,Q,X){"use strict";const{FormInput:S,FormSwitch:v,FormSection:T,FormDivider:R,FormRow:Ie,FormText:m}=Q.Forms,{View:Te,Text:p,ScrollView:ee,TouchableOpacity:_,StyleSheet:te}=s.ReactNative,c=te.create({button:{backgroundColor:"#5865F2",padding:12,borderRadius:8,alignItems:"center",marginVertical:8,marginHorizontal:16},successButton:{backgroundColor:"#3BA55D"},dangerButton:{backgroundColor:"#ED4245"},warningButton:{backgroundColor:"#FAA61A"},buttonText:{color:"white",fontWeight:"bold",fontSize:16},infoText:{color:"#B9BBBE",fontSize:14,marginHorizontal:16,marginVertical:8},warningText:{color:"#FAA61A",fontSize:13,marginHorizontal:16,marginVertical:4},codeText:{fontFamily:"monospace",backgroundColor:"#2F3136",padding:8,borderRadius:4,marginHorizontal:16,marginVertical:4,color:"#DCDDDE"}});function U(){return window.__MESSAGE_FAKER__}function ae(){X.useProxy(a.storage);const[e,t]=s.React.useState(""),[r,n]=s.React.useState(""),[o,h]=s.React.useState(""),[E,W]=s.React.useState(""),[G,q]=s.React.useState(""),[I,J]=s.React.useState(""),ye=async function(){const l=U();if(!l){i.showToast("\u274C Plugin not ready","Small");return}if(!e.trim()){i.showToast("\u274C Enter target user ID","Small");return}if(!r.trim()){i.showToast("\u274C Enter sender user ID","Small");return}if(!o.trim()&&!E.trim()){i.showToast("\u274C Enter message content or embed","Small");return}const k=E||G||I?{title:E||void 0,description:G||void 0,image:I?{url:I}:void 0,thumbnail:I?{url:I}:void 0,type:"rich"}:void 0;try{await l.fakeMessage({targetUserId:e.trim(),fromUserId:r.trim(),content:o.trim(),embed:k,persistent:!0})&&i.showToast("\u2705 Fake message sent!","Check")}catch{i.showToast("\u274C Failed to send message","Small")}},me=async function(){const l=U();if(!l){i.showToast("\u274C Plugin not ready","Small");return}if(!e.trim()||!r.trim()){i.showToast("\u274C Fill in both User IDs first","Small");return}try{await l.quickTest(e.trim(),r.trim())}catch{i.showToast("\u274C Test failed","Small")}},pe=async function(){try{const l=await s.clipboard.getString();l&&(t(l.trim()),i.showToast("\u{1F4CB} Pasted target user ID","clipboard"))}catch{i.showToast("Failed to paste","Small")}},Me=async function(){try{const l=await s.clipboard.getString();l&&(n(l.trim()),i.showToast("\u{1F4CB} Pasted sender user ID","clipboard"))}catch{i.showToast("Failed to paste","Small")}},Se=s.React.useMemo(function(){return Object.values(a.storage.persistentMessages||{}).reduce(function(l,k){return l+(Array.isArray(k)?k.length:0)},0)},[a.storage.persistentMessages]),be=Object.keys(a.storage.persistentMessages||{}).length;return s.React.createElement(ee,null,s.React.createElement(T,{title:"MESSAGE FAKER"},s.React.createElement(m,{style:c.infoText},"\u{1F4AC} Inject fake messages into DMs from anyone."),s.React.createElement(v,{label:"Enable Plugin",subLabel:"Turn the plugin on/off",value:a.storage.enabled,onValueChange:function(l){a.storage.enabled=l,i.showToast(l?"\u2705 Enabled":"\u274C Disabled","Check")}}),s.React.createElement(v,{label:"Auto-Inject on Startup",subLabel:"Automatically show fake messages when Discord starts",value:a.storage.autoInjectOnStartup,onValueChange:function(l){a.storage.autoInjectOnStartup=l}}),s.React.createElement(v,{label:"Prevent Message Deletion",subLabel:"Fake messages can't be deleted (they reinject)",value:a.storage.preventMessageDeletion,onValueChange:function(l){a.storage.preventMessageDeletion=l}}),s.React.createElement(v,{label:"Debug Mode",subLabel:"Enable detailed logging",value:a.storage.debug,onValueChange:function(l){a.storage.debug=l}})),s.React.createElement(R,null),s.React.createElement(T,{title:"CREATE FAKE MESSAGE"},s.React.createElement(m,{style:c.infoText},"\u{1F4DD} Create a fake message in someone's DM"),s.React.createElement(S,{title:"TARGET USER ID (Whose DM)",placeholder:"User ID of person whose DM you want to inject into",value:e,onChange:t}),s.React.createElement(_,{style:c.button,onPress:pe},s.React.createElement(p,{style:c.buttonText},"\u{1F4CB} Paste Target User ID")),s.React.createElement(S,{title:"FROM USER ID (Who message is from)",placeholder:"User ID of who the message appears to be from",value:r,onChange:n}),s.React.createElement(_,{style:c.button,onPress:Me},s.React.createElement(p,{style:c.buttonText},"\u{1F4CB} Paste Sender User ID")),s.React.createElement(S,{title:"MESSAGE CONTENT",placeholder:"The message text",value:o,onChange:h}),s.React.createElement(m,{style:c.infoText},"\u{1F4CE} Optional: Add an embed"),s.React.createElement(S,{title:"EMBED TITLE",placeholder:"Optional embed title",value:E,onChange:W}),s.React.createElement(S,{title:"EMBED DESCRIPTION",placeholder:"Optional embed description",value:G,onChange:q}),s.React.createElement(S,{title:"EMBED IMAGE URL",placeholder:"Optional image URL",value:I,onChange:J}),s.React.createElement(_,{style:[c.button,c.successButton],onPress:ye},s.React.createElement(p,{style:c.buttonText},"\u2709\uFE0F Send Fake Message")),s.React.createElement(_,{style:[c.button,c.warningButton],onPress:me},s.React.createElement(p,{style:c.buttonText},"\u{1F9EA} Quick Test Message"))),s.React.createElement(R,null),s.React.createElement(T,{title:"CONSOLE API"},s.React.createElement(m,{style:c.infoText},"\u{1F527} You can also use the console for advanced usage:"),s.React.createElement(p,{style:c.codeText},`// Send fake message
__MESSAGE_FAKER__.fakeMessage({
  targetUserId: "USER_ID",
  fromUserId: "USER_ID",
  content: "Hello!",
  persistent: true
});`),s.React.createElement(p,{style:c.codeText},`// With embed
__MESSAGE_FAKER__.fakeMessage({
  targetUserId: "USER_ID",
  fromUserId: "USER_ID",
  content: "Check this out!",
  embed: {
    title: "Cool Title",
    description: "Description",
    image: { url: "https://..." }
  }
});`),s.React.createElement(m,{style:c.infoText},"Open Kettu debug console to use these commands")),s.React.createElement(R,null),s.React.createElement(T,{title:"STATISTICS"},s.React.createElement(m,{style:c.infoText},"\u{1F4CA} Current fake messages: ",Se," messages in ",be," channels")),s.React.createElement(R,null),s.React.createElement(T,{title:"DANGER ZONE"},s.React.createElement(_,{style:[c.button,c.dangerButton],onPress:function(){const l=U();l&&l.clearAllMessages(),t(""),n(""),h(""),W(""),q(""),J("")}},s.React.createElement(p,{style:c.buttonText},"\u{1F5D1}\uFE0F Clear ALL Fake Messages")),s.React.createElement(m,{style:c.warningText},"\u26A0\uFE0F This will remove all fake messages from storage. They will disappear on next reload.")),s.React.createElement(m,{style:[c.infoText,{marginTop:16,marginBottom:32,textAlign:"center"}]},"MessageFaker v1.0.2 for Kettu/Bunny/Vendetta"))}a.storage.enabled??=!0,a.storage.debug??=!1,a.storage.persistentMessages??={},a.storage.autoInjectOnStartup??=!0,a.storage.preventMessageDeletion??=!0;const P=[];let C=null,w=null,se=null,j=null,L=null,re=null,d=null,F=null,A=null;const g=function(e,t){a.storage.debug&&M.logger.log(`[MessageInjector] ${e}`,t||"")},u=function(e,t){M.logger.error(`[MessageInjector] ${e}`,t||"")},O=function(e){return new Promise(function(t){return setTimeout(t,e)})};function ne(e){if(!e)return new Date().toISOString();try{const t=new Date(e);return isNaN(t.getTime())?(u("Invalid timestamp, using current time",e),new Date().toISOString()):t.toISOString()}catch(t){return u("Failed to parse timestamp, using current time",t),new Date().toISOString()}}function N(e){return!e||typeof e!="string"?!1:/^\d+$/.test(e.trim())}function ie(e){if(e)try{const t={type:"rich"};return e.title&&typeof e.title=="string"&&(t.title=e.title.substring(0,256)),e.description&&typeof e.description=="string"&&(t.description=e.description.substring(0,4096)),e.image?.url&&typeof e.image.url=="string"&&(t.image={url:e.image.url}),e.thumbnail?.url&&typeof e.thumbnail.url=="string"&&(t.thumbnail={url:e.thumbnail.url}),Object.keys(t).length>1?t:void 0}catch(t){u("Failed to validate embed",t);return}}function b(e,t=[]){for(const r of e)try{const n=$.findByStoreName(r);if(n&&(t.length===0||t.every(function(o){return typeof n[o]=="function"})))return g(`Found store: ${r}`),n}catch{}if(t.length>0)try{const r=$.findByProps(...t);if(r)return g(`Found store by props: ${t.join(", ")}`),r}catch{}return null}async function oe(e){try{if(w){const t=w.getUser?.(e);if(t){const r={username:t.username||"Unknown User",discriminator:t.discriminator||"0",global_name:t.globalName||t.global_name||void 0,avatar:t.avatar?`https://cdn.discordapp.com/avatars/${e}/${t.avatar}.${t.avatar.startsWith("a_")?"gif":"png"}`:null,public_flags:t.publicFlags||t.public_flags||0};if(t.avatarDecorationData||t.avatar_decoration_data){const o=t.avatarDecorationData||t.avatar_decoration_data;r.avatar_decoration_data={asset:o.asset,sku_id:o.skuId||o.sku_id}}else if(t.avatarDecoration||t.avatar_decoration){const o=t.avatarDecoration||t.avatar_decoration;r.avatar_decoration_data={asset:o,sku_id:void 0}}const n=t.clan||t.primaryGuild||t.primary_guild;return n&&(r.clan={identity_guild_id:n.identityGuildId||n.identity_guild_id||null,identity_enabled:n.identityEnabled??n.identity_enabled??!1,tag:n.tag||null,badge:n.badge||null}),r}}}catch(t){u("Failed to get user info",t)}return{username:"Unknown User",discriminator:"0",avatar:null,public_flags:0}}function H(e){try{if(C?.getDMFromUserId){const t=C.getDMFromUserId(e);return g(`DM channel for user ${e}: ${t}`),t}}catch(t){u("Failed to get DM channel",t)}return null}async function le(e){try{let t=H(e);if(!t&&L)try{const r=L.getPrivateChannelIds?.();if(r)for(const n of r){const o=C?.getChannel?.(n);if(o?.type===1&&o.recipients?.includes(e)){t=n;break}}t||(s.FluxDispatcher.dispatch({type:"CHANNEL_SELECT",channelId:null,guildId:null}),await O(100),t=H(e))}catch(r){u("Failed to ensure DM channel",r)}return t}catch(t){return u("Failed to ensure DM channel",t),null}}function ce(){const e=Date.now(),t=Math.floor(Math.random()*4096);return`${e}${t.toString().padStart(4,"0")}`}async function ue(e){if(!N(e.userId))throw new Error("Invalid user ID");const t=await oe(e.userId);let r=e.username||t.username,n=e.avatar||t.avatar;const o=ne(e.timestamp),h=ie(e.embed),E={id:e.messageId||ce(),channel_id:e.channelId,author:{id:e.userId,username:r||"Unknown User",global_name:t.global_name,discriminator:t.discriminator||"0",avatar:n?n.split("/").pop()?.split(".")[0]:null,avatar_decoration_data:t.avatar_decoration_data,clan:t.clan,public_flags:t.public_flags||0,bot:!1},content:(e.content||"").substring(0,2e3),timestamp:o,edited_timestamp:null,tts:!1,mention_everyone:!1,mentions:[],mention_roles:[],attachments:[],embeds:h?[h]:[],reactions:[],pinned:!1,type:0,flags:0};return g("Created message object",E),E}function x(e){if(!s.FluxDispatcher)return u("FluxDispatcher not available"),!1;try{return s.FluxDispatcher.dispatch({type:"MESSAGE_CREATE",channelId:e.channel_id,message:e,optimistic:!1,sendMessageOptions:{},isPushNotification:!1}),g("Message injected successfully",e.id),!0}catch(t){return u("Failed to inject message",t),!1}}function D(){try{typeof a.storage.persistentMessages!="object"&&(a.storage.persistentMessages={}),Object.keys(a.storage.persistentMessages).forEach(function(e){Array.isArray(a.storage.persistentMessages[e])||delete a.storage.persistentMessages[e]}),a.storage.persistentMessages=JSON.parse(JSON.stringify(a.storage.persistentMessages)),g("Saved persistent messages",Object.keys(a.storage.persistentMessages).length)}catch(e){u("Failed to save persistent messages",e),a.storage.persistentMessages={}}}async function B(e){try{if(!N(e.fromUserId))return u("Invalid sender user ID"),i.showToast&&i.showToast("\u274C Invalid sender user ID","Small"),!1;let t=e.channelId;if(!t&&e.targetUserId){if(!N(e.targetUserId))return u("Invalid target user ID"),i.showToast&&i.showToast("\u274C Invalid target user ID","Small"),!1;t=await le(e.targetUserId)}if(!t)return u("No valid channel ID found"),i.showToast&&i.showToast("\u274C Could not find DM channel","Small"),!1;const r=await ue({channelId:t,userId:e.fromUserId,content:e.content,username:e.username,avatar:e.avatar,embed:e.embed});e.persistent&&(a.storage.persistentMessages[t]||(a.storage.persistentMessages[t]=[]),a.storage.persistentMessages[t].push(r),D(),g("Message saved to persistent storage",r.id));const n=x(r);if(n){g("Fake message sent successfully");try{s.FluxDispatcher.dispatch({type:"CHANNEL_SELECT",channelId:t,guildId:null}),await O(50),d&&d!==t&&s.FluxDispatcher.dispatch({type:"CHANNEL_SELECT",channelId:d,guildId:null})}catch(o){g("Could not ensure channel visibility",o)}}return n}catch(t){return u("Failed to send fake message",t),i.showToast&&i.showToast("\u274C Failed to send message","Small"),!1}}function f(e){if(!a.storage.persistentMessages[e])return;const t=a.storage.persistentMessages[e];if(!Array.isArray(t)){delete a.storage.persistentMessages[e],D();return}g(`Reinjecting ${t.length} messages for channel ${e}`),t.forEach(function(r,n){setTimeout(function(){try{x(r)}catch(o){u("Failed to reinject message",o)}},n*50)})}function de(){try{if(!s.FluxDispatcher)return;const e=Z.before("dispatch",s.FluxDispatcher,function(t){if(!a.storage.enabled)return;const r=t[0];if(!(!r||!r.type)){if(a.storage.preventMessageDeletion&&r.type==="MESSAGE_DELETE"){const n=r.id,o=r.channelId;if(o&&a.storage.persistentMessages[o]){const h=a.storage.persistentMessages[o].find(function(E){return E.id===n});h&&(g("Prevented deletion of fake message",n),t[0]={type:"NOOP"},setTimeout(function(){return x(h)},50))}}if(a.storage.preventMessageDeletion&&r.type==="MESSAGE_DELETE_BULK"){const n=r.channelId;if(n&&a.storage.persistentMessages[n]){const o=r.ids||[];a.storage.persistentMessages[n].some(function(h){return o.includes(h.id)})&&(t[0]={type:"NOOP"},setTimeout(function(){return f(n)},100))}}if(r.type==="LOAD_MESSAGES_SUCCESS"||r.type==="LOAD_MESSAGES"){const n=r.channelId;n&&a.storage.persistentMessages[n]&&(setTimeout(function(){return f(n)},200),setTimeout(function(){return f(n)},500),setTimeout(function(){return f(n)},1e3))}if((r.type==="CACHE_LOADED"||r.type==="OVERLAY_INITIALIZE"||r.type==="CHANNEL_UPDATES"||r.type==="CONNECTION_OPEN")&&d&&a.storage.persistentMessages[d]&&setTimeout(function(){return d&&f(d)},300),(r.type==="USER_PROFILE_MODAL_OPEN"||r.type==="USER_PROFILE_MODAL_CLOSE"||r.type==="LAYER_PUSH"||r.type==="LAYER_POP"||r.type==="TYPING_START"||r.type==="TYPING_STOP")&&d&&a.storage.persistentMessages[d]&&(setTimeout(function(){return d&&f(d)},50),setTimeout(function(){return d&&f(d)},300)),r.type==="MESSAGE_UPDATE"){const n=r.message?.channel_id;n&&a.storage.persistentMessages[n]&&setTimeout(function(){return f(n)},100)}}});P.push(e),g("Message persistence system setup with comprehensive event coverage")}catch(e){u("Failed to setup message persistence",e)}}function ge(){F=setInterval(function(){if(j)try{const e=j.getChannelId?.();e&&e!==d&&(d=e,a.storage.persistentMessages[e]&&(f(e),setTimeout(function(){f(e)},200)))}catch{}},1e3),A=setInterval(function(){d&&a.storage.persistentMessages[d]&&f(d)},2e3)}function K(){a.storage.persistentMessages={},D(),g("Cleared all persistent messages"),i.showToast&&i.showToast("\u2705 All fake messages cleared","Check")}function V(e){a.storage.persistentMessages[e]&&(delete a.storage.persistentMessages[e],D(),g(`Cleared messages for channel ${e}`),i.showToast&&i.showToast("\u2705 Channel messages cleared","Check"))}function z(){return a.storage.persistentMessages}async function Y(e,t){return await B({targetUserId:e,fromUserId:t,content:"Test message from Message Injector plugin! \u{1F389}",persistent:!0})}async function fe(){try{C=b(["ChannelStore"],["getChannel","getDMFromUserId"]),w=b(["UserStore","CurrentUserStore"],["getUser","getCurrentUser"]),se=b(["MessageStore"],["getMessages","getMessage"]),j=b(["SelectedChannelStore"],["getChannelId"]),L=b(["PrivateChannelStore"],["getPrivateChannelIds"]),re=b(["RelationshipStore"],["getRelationships"]);const e=C&&w;return e?g("All critical modules loaded"):u("Some modules failed to load"),e}catch(e){return u("Failed to initialize modules",e),!1}}function he(){try{if(typeof a.storage.persistentMessages!="object"||a.storage.persistentMessages===null){M.logger.warn("[MessageInjector] Corrupted storage detected, resetting..."),a.storage.persistentMessages={};return}Object.keys(a.storage.persistentMessages).forEach(function(e){Array.isArray(a.storage.persistentMessages[e])?(a.storage.persistentMessages[e]=a.storage.persistentMessages[e].filter(function(t){return t&&t.id&&t.channel_id&&t.author&&t.timestamp}),a.storage.persistentMessages[e].length===0&&delete a.storage.persistentMessages[e]):delete a.storage.persistentMessages[e]}),D()}catch(e){u("Failed to recover storage",e),a.storage.persistentMessages={}}}var Ee={onLoad:async function(){try{if(M.logger.log("[MessageInjector] Loading..."),he(),await O(1e3),!await fe()){u("Failed to load critical modules"),i.showToast&&i.showToast("\u274C Plugin failed to load","Small");return}if(de(),ge(),a.storage.autoInjectOnStartup){await O(2e3);const e=Object.keys(a.storage.persistentMessages).length;e>0&&(g(`Auto-injecting messages for ${e} channels`),Object.keys(a.storage.persistentMessages).forEach(function(t){setTimeout(function(){f(t)},500)}))}window.__MESSAGE_FAKER__={fakeMessage:B,clearAllMessages:K,clearChannelMessages:V,getAllMessages:z,quickTest:Y,reinjectChannel:f,getStatus:function(){return{enabled:a.storage.enabled,messageCount:Object.values(a.storage.persistentMessages).reduce(function(e,t){return e+t.length},0),channelCount:Object.keys(a.storage.persistentMessages).length}}},M.logger.log("[MessageInjector] \u2705 Loaded successfully")}catch(e){u("Fatal error during load",e),i.showToast&&i.showToast("\u274C Plugin failed to load","Small")}},onUnload:function(){try{for(const e of P)try{e()}catch{}P.length=0,F&&(clearInterval(F),F=null),A&&(clearInterval(A),A=null),window.__MESSAGE_FAKER__&&delete window.__MESSAGE_FAKER__,M.logger.log("[MessageInjector] Unloaded"),i.showToast&&i.showToast("Plugin unloaded","Check")}catch(e){u("Error during unload",e)}},settings:ae};return y.clearAllMessages=K,y.clearChannelMessages=V,y.default=Ee,y.fakeMessage=B,y.getAllMessages=z,y.quickTest=Y,Object.defineProperty(y,"__esModule",{value:!0}),y})({},vendetta.metro.common,vendetta.metro,vendetta.patcher,vendetta.plugin,vendetta.ui.toasts,vendetta,vendetta.ui.components,vendetta.storage);
