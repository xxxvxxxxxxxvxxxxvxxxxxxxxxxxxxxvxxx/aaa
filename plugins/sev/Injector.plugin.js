import{React as s,ReactNative as X,clipboard as K}from"@vendetta/metro/common";import{Forms as R}from"@vendetta/ui/components";import{useProxy as ee}from"@vendetta/storage";import{storage as m}from"@vendetta/plugin";import{showToast as f}from"@vendetta/ui/toasts";var{FormInput:E,FormSwitch:D,FormSection:I,FormDivider:A,FormRow:Ae,FormText:b}=R,{View:_e,Text:S,ScrollView:te,TouchableOpacity:C,StyleSheet:se}=X,r=se.create({button:{backgroundColor:"#5865F2",padding:12,borderRadius:8,alignItems:"center",marginVertical:8,marginHorizontal:16},successButton:{backgroundColor:"#3BA55D"},dangerButton:{backgroundColor:"#ED4245"},warningButton:{backgroundColor:"#FAA61A"},buttonText:{color:"white",fontWeight:"bold",fontSize:16},infoText:{color:"#B9BBBE",fontSize:14,marginHorizontal:16,marginVertical:8},warningText:{color:"#FAA61A",fontSize:13,marginHorizontal:16,marginVertical:4},codeText:{fontFamily:"monospace",backgroundColor:"#2F3136",padding:8,borderRadius:4,marginHorizontal:16,marginVertical:4,color:"#DCDDDE"}}),z=()=>{ee(m);let[e,t]=s.useState(""),[n,o]=s.useState(""),[p,h]=s.useState(""),[y,G]=s.useState(""),[w,V]=s.useState(""),[M,$]=s.useState(""),Y=async()=>{if(!e.trim()){f("\u274C Enter target user ID","Small");return}if(!n.trim()){f("\u274C Enter sender user ID","Small");return}if(!p.trim()&&!y.trim()){f("\u274C Enter message content or embed","Small");return}let i=y||w||M?{title:y||void 0,description:w||void 0,image:M?{url:M}:void 0,thumbnail:M?{url:M}:void 0,type:"rich"}:void 0;await _({targetUserId:e.trim(),fromUserId:n.trim(),content:p.trim(),embed:i,persistent:!0})&&f("\u2705 Fake message sent!","Check")},W=async()=>{if(!e.trim()||!n.trim()){f("\u274C Fill in both User IDs first","Small");return}await P(e.trim(),n.trim())},q=async()=>{try{let i=await K.getString();i&&(t(i.trim()),f("\u{1F4CB} Pasted target user ID","clipboard"))}catch{f("Failed to paste","Small")}},J=async()=>{try{let i=await K.getString();i&&(o(i.trim()),f("\u{1F4CB} Pasted sender user ID","clipboard"))}catch{f("Failed to paste","Small")}},Q=s.useMemo(()=>Object.values(m.persistentMessages||{}).reduce((i,O)=>i+(Array.isArray(O)?O.length:0),0),[m.persistentMessages]),Z=Object.keys(m.persistentMessages||{}).length;return s.createElement(te,null,s.createElement(I,{title:"MESSAGE FAKER"},s.createElement(b,{style:r.infoText},"\u{1F4AC} Inject fake messages into DMs from anyone."),s.createElement(D,{label:"Enable Plugin",subLabel:"Turn the plugin on/off",value:m.enabled,onValueChange:i=>{m.enabled=i,f(i?"\u2705 Enabled":"\u274C Disabled","Check")}}),s.createElement(D,{label:"Auto-Inject on Startup",subLabel:"Automatically show fake messages when Discord starts",value:m.autoInjectOnStartup,onValueChange:i=>{m.autoInjectOnStartup=i}}),s.createElement(D,{label:"Prevent Message Deletion",subLabel:"Fake messages can't be deleted (they reinject)",value:m.preventMessageDeletion,onValueChange:i=>{m.preventMessageDeletion=i}}),s.createElement(D,{label:"Debug Mode",subLabel:"Enable detailed logging",value:m.debug,onValueChange:i=>{m.debug=i}})),s.createElement(A,null),s.createElement(I,{title:"CREATE FAKE MESSAGE"},s.createElement(b,{style:r.infoText},"\u{1F4DD} Create a fake message in someone's DM"),s.createElement(E,{title:"TARGET USER ID (Whose DM)",placeholder:"User ID of person whose DM you want to inject into",value:e,onChange:t}),s.createElement(C,{style:r.button,onPress:q},s.createElement(S,{style:r.buttonText},"\u{1F4CB} Paste Target User ID")),s.createElement(E,{title:"FROM USER ID (Who message is from)",placeholder:"User ID of who the message appears to be from",value:n,onChange:o}),s.createElement(C,{style:r.button,onPress:J},s.createElement(S,{style:r.buttonText},"\u{1F4CB} Paste Sender User ID")),s.createElement(E,{title:"MESSAGE CONTENT",placeholder:"The message text",value:p,onChange:h}),s.createElement(b,{style:r.infoText},"\u{1F4CE} Optional: Add an embed"),s.createElement(E,{title:"EMBED TITLE",placeholder:"Optional embed title",value:y,onChange:G}),s.createElement(E,{title:"EMBED DESCRIPTION",placeholder:"Optional embed description",value:w,onChange:V}),s.createElement(E,{title:"EMBED IMAGE URL",placeholder:"Optional image URL",value:M,onChange:$}),s.createElement(C,{style:[r.button,r.successButton],onPress:Y},s.createElement(S,{style:r.buttonText},"\u2709\uFE0F Send Fake Message")),s.createElement(C,{style:[r.button,r.warningButton],onPress:W},s.createElement(S,{style:r.buttonText},"\u{1F9EA} Quick Test Message"))),s.createElement(A,null),s.createElement(I,{title:"CONSOLE API"},s.createElement(b,{style:r.infoText},"\u{1F527} You can also use the console for advanced usage:"),s.createElement(S,{style:r.codeText},`// Send fake message
__MESSAGE_FAKER__.fakeMessage({
  targetUserId: "USER_ID",
  fromUserId: "USER_ID",
  content: "Hello!",
  persistent: true
});`),s.createElement(S,{style:r.codeText},`// With embed
__MESSAGE_FAKER__.fakeMessage({
  targetUserId: "USER_ID",
  fromUserId: "USER_ID",
  content: "Check this out!",
  embed: {
    title: "Cool Title",
    description: "Description",
    image: { url: "https://..." }
  }
});`),s.createElement(b,{style:r.infoText},"Open Kettu debug console to use these commands")),s.createElement(A,null),s.createElement(I,{title:"STATISTICS"},s.createElement(b,{style:r.infoText},"\u{1F4CA} Current fake messages: ",Q," messages in ",Z," channels")),s.createElement(A,null),s.createElement(I,{title:"DANGER ZONE"},s.createElement(C,{style:[r.button,r.dangerButton],onPress:()=>{k(),t(""),o(""),h(""),G(""),V(""),$("")}},s.createElement(S,{style:r.buttonText},"\u{1F5D1}\uFE0F Clear ALL Fake Messages")),s.createElement(b,{style:r.warningText},"\u26A0\uFE0F This will remove all fake messages from storage. They will disappear on next reload.")),s.createElement(b,{style:[r.infoText,{marginTop:16,marginBottom:32,textAlign:"center"}]},"MessageFaker v1.0.0 for Kettu/Bunny/Vendetta"))};var ne=typeof window.bunny<"u",Ue=typeof window.vendetta<"u",U=ne?window.bunny:window.vendetta,{findByProps:ae,findByStoreName:re}=U.metro,{after:we,before:oe}=U.patcher,{storage:a}=U.plugin,{showToast:l}=U.ui?.toasts||{showToast:console.log};a.enabled??=!0;a.debug??=!1;a.persistentMessages??={};a.autoInjectOnStartup??=!0;a.preventMessageDeletion??=!0;var j=[],T=null,v=null,x=null,ie=null,L=null,c=null,u=(e,t)=>{a.debug&&console.log(`[MessageInjector] ${e}`,t||"")},d=(e,t)=>{console.error(`[MessageInjector] ${e}`,t||"")},H=e=>new Promise(t=>setTimeout(t,e));function F(e,t=[]){for(let n of e)try{let o=re(n);if(o&&(t.length===0||t.every(h=>typeof o[h]=="function")))return u(`Found store: ${n}`),o}catch{}if(t.length>0)try{let n=ae(...t);if(n)return u(`Found store by props: ${t.join(", ")}`),n}catch{}return null}async function le(e){try{if(x){let t=x.getUser?.(e);if(t)return{username:t.username||"Unknown User",discriminator:t.discriminator||"0",avatar:t.avatar?`https://cdn.discordapp.com/avatars/${e}/${t.avatar}.png`:null}}}catch(t){d("Failed to get user info",t)}return{username:"Unknown User",discriminator:"0",avatar:null}}function ce(e){try{if(v?.getDMFromUserId){let t=v.getDMFromUserId(e);return u(`DM channel for user ${e}: ${t}`),t}}catch(t){d("Failed to get DM channel",t)}return null}function ue(){return`${Date.now()}${Math.random().toString(36).substring(2,11)}`}async function ge(e){let t=e.username,n=e.avatar;if(!t){let p=await le(e.userId);t=p.username,n||(n=p.avatar)}let o={id:e.messageId||ue(),channel_id:e.channelId,author:{id:e.userId,username:t||"Unknown User",discriminator:"0",avatar:n||void 0,bot:!1,public_flags:0},content:e.content||"",timestamp:e.timestamp||new Date().toISOString(),edited_timestamp:null,tts:!1,mention_everyone:!1,mentions:[],mention_roles:[],attachments:[],embeds:e.embed?[e.embed]:[],reactions:[],pinned:!1,type:0,flags:0};return u("Created message object",o),o}function N(e){if(!T)return d("FluxDispatcher not available"),!1;try{return T.dispatch({type:"MESSAGE_CREATE",channelId:e.channel_id,message:e,optimistic:!1,sendMessageOptions:{},isPushNotification:!1}),u("Message injected successfully",e.id),!0}catch(t){return d("Failed to inject message",t),!1}}function B(){try{a.persistentMessages=JSON.parse(JSON.stringify(a.persistentMessages)),u("Saved persistent messages",Object.keys(a.persistentMessages).length)}catch(e){d("Failed to save persistent messages",e)}}async function _(e){try{let t=e.channelId;if(!t&&e.targetUserId&&(t=ce(e.targetUserId)),!t)return d("No valid channel ID found"),l&&l("Failed: Could not find DM channel","Small"),!1;let n=await ge({channelId:t,userId:e.fromUserId,content:e.content,username:e.username,avatar:e.avatar,embed:e.embed});e.persistent&&(a.persistentMessages[t]||(a.persistentMessages[t]=[]),a.persistentMessages[t].push(n),B(),u("Message saved to persistent storage",n.id));let o=N(n);return o&&u("Fake message sent successfully"),o}catch(t){return d("Failed to send fake message",t),l&&l("Failed to send fake message","Small"),!1}}function g(e){if(!a.persistentMessages[e])return;let t=a.persistentMessages[e];u(`Reinjecting ${t.length} messages for channel ${e}`),t.forEach((n,o)=>{setTimeout(()=>{N(n)},o*50)})}function de(){try{if(!T)return;j.push(oe("dispatch",T,e=>{if(!a.enabled)return;let t=e[0];if(!(!t||!t.type)){if(a.preventMessageDeletion&&t.type==="MESSAGE_DELETE"){let n=t.id,o=t.channelId;if(o&&a.persistentMessages[o]){let h=a.persistentMessages[o].find(y=>y.id===n);h&&(u("Prevented deletion of fake message",n),e[0]={type:"NOOP"},setTimeout(()=>N(h),50))}}if(a.preventMessageDeletion&&t.type==="MESSAGE_DELETE_BULK"){let n=t.channelId;if(n&&a.persistentMessages[n]){let o=t.ids||[];a.persistentMessages[n].some(y=>o.includes(y.id))&&(e[0]={type:"NOOP"},setTimeout(()=>g(n),100))}}if(t.type==="LOAD_MESSAGES_SUCCESS"||t.type==="LOAD_MESSAGES"){let n=t.channelId;n&&a.persistentMessages[n]&&(setTimeout(()=>g(n),200),setTimeout(()=>g(n),500),setTimeout(()=>g(n),1e3))}if((t.type==="CACHE_LOADED"||t.type==="OVERLAY_INITIALIZE"||t.type==="CHANNEL_UPDATES")&&c&&a.persistentMessages[c]&&setTimeout(()=>c&&g(c),300),(t.type==="USER_PROFILE_MODAL_OPEN"||t.type==="USER_PROFILE_MODAL_CLOSE"||t.type==="LAYER_PUSH"||t.type==="LAYER_POP"||t.type==="TYPING_START"||t.type==="TYPING_STOP")&&c&&a.persistentMessages[c]&&(setTimeout(()=>c&&g(c),50),setTimeout(()=>c&&g(c),300)),t.type==="MESSAGE_UPDATE"){let n=t.message?.channel_id;n&&a.persistentMessages[n]&&setTimeout(()=>g(n),100)}}})),u("Message persistence system setup with comprehensive event coverage")}catch(e){d("Failed to setup message persistence",e)}}function me(){setInterval(()=>{if(L)try{let e=L.getChannelId?.();e&&e!==c&&(c=e,a.persistentMessages[e]&&(g(e),setTimeout(()=>{g(e)},200)))}catch{}},1e3),setInterval(()=>{c&&a.persistentMessages[c]&&g(c)},2e3)}function k(){a.persistentMessages={},B(),u("Cleared all persistent messages"),l&&l("All fake messages cleared","Check")}function fe(e){a.persistentMessages[e]&&(delete a.persistentMessages[e],B(),u(`Cleared messages for channel ${e}`),l&&l("Channel messages cleared","Check"))}function pe(){return a.persistentMessages}async function P(e,t){return await _({targetUserId:e,fromUserId:t,content:"Test message from Message Injector plugin!",persistent:!0})}async function he(){try{T=F(["FluxDispatcher","Dispatcher"],["dispatch","subscribe"]),v=F(["ChannelStore"],["getChannel","getDMFromUserId"]),x=F(["UserStore","CurrentUserStore"],["getUser","getCurrentUser"]),ie=F(["MessageStore"],["getMessages","getMessage"]),L=F(["SelectedChannelStore"],["getChannelId"]);let e=T&&v&&x;return e?u("All critical modules loaded"):d("Some modules failed to load"),e}catch(e){return d("Failed to initialize modules",e),!1}}(async()=>{try{if(console.log("[MessageInjector] Loading..."),await H(1e3),!await he()){d("Failed to load critical modules"),l&&l("Plugin failed to load","Small");return}if(de(),me(),a.autoInjectOnStartup){await H(2e3);let t=Object.keys(a.persistentMessages).length;t>0&&(u(`Auto-injecting messages for ${t} channels`),Object.keys(a.persistentMessages).forEach(n=>{setTimeout(()=>{g(n)},500)}))}window.__MESSAGE_FAKER__={fakeMessage:_,clearAllMessages:k,clearChannelMessages:fe,getAllMessages:pe,quickTest:P,reinjectChannel:g,getStatus:()=>({enabled:a.enabled,messageCount:Object.values(a.persistentMessages).reduce((t,n)=>t+n.length,0),channelCount:Object.keys(a.persistentMessages).length})},console.log("[MessageInjector] Loaded successfully"),l&&l("Message Injector loaded!","Check")}catch(e){d("Fatal error during load",e),l&&l("Plugin failed to load","Small")}})();var ye=()=>{},be=()=>{try{for(let e of j)try{e()}catch{}j.length=0,window.__MESSAGE_FAKER__&&delete window.__MESSAGE_FAKER__,console.log("[MessageInjector] Unloaded"),l&&l("Plugin unloaded","Check")}catch(e){d("Error during unload",e)}};var Oe={onLoad:ye,onUnload:be,settings:z};export{k as clearAllMessages,fe as clearChannelMessages,Oe as default,_ as fakeMessage,pe as getAllMessages,ye as onLoad,be as onUnload,P as quickTest,z as settings};
